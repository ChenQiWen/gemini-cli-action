# ===============================================
# ğŸ”§ æ™ºèƒ½é—®é¢˜ä¿®å¤å™¨ - è‡ªåŠ¨ç”Ÿæˆä»£ç ä¿®å¤æ–¹æ¡ˆ
# ===============================================
# 
# ğŸ¯ ç”¨é€”ï¼šåˆ†æIssueæè¿°ï¼Œè‡ªåŠ¨ç”Ÿæˆä»£ç ä¿®å¤å»ºè®®å’Œè¡¥ä¸
# ğŸ“‹ åŠŸèƒ½ï¼š
#   - Bugè‡ªåŠ¨è¯Šæ–­å’Œä¿®å¤
#   - ä»£ç ç¼ºé™·æ£€æµ‹å’Œä¿®è¡¥
#   - æ€§èƒ½ä¼˜åŒ–å»ºè®®
#   - å®‰å…¨æ¼æ´ä¿®å¤
# 
# ğŸš€ è§¦å‘ï¼š@abc fix this issue
# ğŸ¤– AIæ¨¡å‹ï¼šGoogle Gemini API  
# ===============================================

name: ğŸ”§ æ™ºèƒ½é—®é¢˜ä¿®å¤å™¨ - è‡ªåŠ¨ä»£ç ä¿®å¤ç”Ÿæˆ

# è§¦å‘æ¡ä»¶ï¼šå¯å¤ç”¨å·¥ä½œæµ
on:
  workflow_call:
    inputs:
      issue_number:
        description: 'éœ€è¦ä¿®å¤çš„Issueç¼–å·'
        required: true
        type: number
      issue_title:
        description: 'Issueæ ‡é¢˜'
        required: true
        type: string
      issue_body:
        description: 'Issueæè¿°å†…å®¹'
        required: true
        type: string
      fix_type:
        description: 'ä¿®å¤ç±»å‹ï¼šbug|performance|security|enhancement'
        required: false
        type: string
        default: 'bug'
    secrets:
      APP_PRIVATE_KEY:
        required: false
      GEMINI_API_KEY:
        required: false

# æƒé™è®¾ç½®
permissions:
  contents: write    # éœ€è¦åˆ›å»ºä¿®å¤åˆ†æ”¯å’Œæäº¤ä»£ç 
  pull-requests: write
  issues: write

jobs:
  intelligent-fix:
    name: ğŸ”§ AIé©±åŠ¨çš„é—®é¢˜ä¿®å¤
    runs-on: ubuntu-latest
    timeout-minutes: 15
    
    steps:
      # æ­¥éª¤1: æ£€å‡ºä»£ç 
      - name: ğŸ“¥ æ£€å‡ºä»£ç ä»“åº“
        uses: actions/checkout@v4
        with:
          fetch-depth: 0  # è·å–å®Œæ•´å†å²
          
      # æ­¥éª¤2: ç”ŸæˆGitHub App Token
      - name: ğŸ”‘ ç”ŸæˆGitHub App Token
        id: generate_token
        if: ${{ vars.APP_ID != '' }}
        uses: actions/create-github-app-token@v2
        with:
          app-id: ${{ vars.APP_ID }}
          private-key: ${{ secrets.APP_PRIVATE_KEY }}

      # æ­¥éª¤3: è®¾ç½®Gitç”¨æˆ·
      - name: âš™ï¸ é…ç½®Gitç”¨æˆ·ä¿¡æ¯
        run: |
          git config --global user.name 'ai-fixer[bot]'
          git config --global user.email 'ai-fixer[bot]@users.noreply.github.com'

      # æ­¥éª¤4: åˆ†æä»£ç åº“ç»“æ„
      - name: ğŸ” åˆ†æé¡¹ç›®ç»“æ„å’Œä»£ç 
        id: analyze_codebase
        run: |
          echo "ğŸ“Š åˆ†æé¡¹ç›®ç»“æ„..."
          
          # è·å–é¡¹ç›®æ–‡ä»¶ç»“æ„
          find . -type f -name "*.py" -o -name "*.js" -o -name "*.ts" -o -name "*.java" -o -name "*.go" -o -name "*.rs" | head -20 > /tmp/code_files.txt
          
          # ç”Ÿæˆé¡¹ç›®æ¦‚è§ˆ
          {
            echo "é¡¹ç›®ç»“æ„:"
            tree -L 3 -I 'node_modules|.git|__pycache__|.pytest_cache' || ls -la
            echo -e "\nä¸»è¦ä»£ç æ–‡ä»¶:"
            cat /tmp/code_files.txt
            echo -e "\næœ€è¿‘æäº¤:"
            git log --oneline -5
          } > /tmp/project_overview.txt
          
          # è®¾ç½®è¾“å‡ºå˜é‡
          echo "project_overview<<EOF" >> $GITHUB_OUTPUT
          cat /tmp/project_overview.txt >> $GITHUB_OUTPUT
          echo "EOF" >> $GITHUB_OUTPUT

      # æ­¥éª¤5: AIåˆ†æå’Œä¿®å¤æ–¹æ¡ˆç”Ÿæˆ
      - name: ğŸ¤– AIé—®é¢˜åˆ†æä¸ä¿®å¤æ–¹æ¡ˆç”Ÿæˆ
        id: ai_fix_analysis
        uses: google-github-actions/run-gemini-cli@v0.1.12
        env:
          GITHUB_TOKEN: ${{ steps.generate_token.outputs.token || secrets.GITHUB_TOKEN }}
          ISSUE_TITLE: ${{ inputs.issue_title }}
          ISSUE_BODY: ${{ inputs.issue_body }}
          ISSUE_NUMBER: ${{ inputs.issue_number }}
          FIX_TYPE: ${{ inputs.fix_type }}
          PROJECT_OVERVIEW: ${{ steps.analyze_codebase.outputs.project_overview }}
        with:
          gemini_api_key: '${{ secrets.GEMINI_API_KEY }}'
          gemini_debug: false  # å…³é—­è°ƒè¯•æ¨¡å¼
          gcp_workload_identity_provider: '${{ vars.GCP_WIF_PROVIDER }}'
          gcp_project_id: '${{ vars.GOOGLE_CLOUD_PROJECT }}'
          gcp_location: '${{ vars.GOOGLE_CLOUD_LOCATION }}'
          gcp_service_account: '${{ vars.SERVICE_ACCOUNT_EMAIL }}'
          use_vertex_ai: '${{ vars.GOOGLE_GENAI_USE_VERTEXAI }}'
          settings: |-
            {
              "debug": false,
              "maxSessionTurns": 1,
              "temperature": 0.2,
              "candidateCount": 1,
              "maxOutputTokens": 6000,
              "responseMimeType": "application/json",
              "systemInstruction": "ä½ æ˜¯ä¸€ä¸ªä¸“ä¸šçš„ä»£ç ä¿®å¤ä¸“å®¶ï¼Œæä¾›ç»“æ„åŒ–çš„JSONå“åº”ï¼ŒåŒ…å«å…·ä½“çš„æ–‡ä»¶ä¿®æ”¹æ–¹æ¡ˆã€‚è¯·ä½¿ç”¨ä¸­æ–‡è¿›è¡Œæ‰€æœ‰åˆ†æå’Œè¯´æ˜ã€‚"
            }
          prompt: |-
            é‡è¦æç¤ºï¼šè¯·åªç”¨æœ‰æ•ˆçš„JSONæ ¼å¼å›å¤ï¼Œä¸è¦ä½¿ç”¨markdownæˆ–å¯¹è¯æ–‡æœ¬ã€‚è¯·ä½¿ç”¨ä¸­æ–‡è¿›è¡Œæ‰€æœ‰åˆ†æå’Œè¯´æ˜ã€‚
            
            ä½ æ˜¯ä¸€ä¸ªä¸“ä¸šçš„ä»£ç ä¿®å¤ä¸“å®¶ã€‚è¯·åˆ†æé—®é¢˜å¹¶æä¾›å¯æ‰§è¡Œçš„æ–‡ä»¶ä¿®æ”¹æ–¹æ¡ˆã€‚
            
            ## é—®é¢˜ä¿¡æ¯
            - Issue #${ISSUE_NUMBER}: ${ISSUE_TITLE}
            - ä¿®å¤ç±»å‹: ${FIX_TYPE}
            - é—®é¢˜æè¿°: ${ISSUE_BODY}
            
            ## é¡¹ç›®ç»“æ„
            ${PROJECT_OVERVIEW}
            
            ## å¿…éœ€çš„JSONå“åº”æ ¼å¼
            {
              "analysis": {
                "root_cause": "è¯¦ç»†çš„æ ¹æœ¬åŸå› åˆ†æ",
                "severity": "low|medium|high|critical",
                "impact_scope": "å—å½±å“çš„æ¨¡å—/åŠŸèƒ½æè¿°",
                "fix_strategy": "æ•´ä½“ä¿®å¤ç­–ç•¥æè¿°"
              },
              "file_modifications": [
                {
                  "file_path": "ç›¸å¯¹è·¯å¾„/æ–‡ä»¶å.æ‰©å±•å",
                  "action": "create|modify|delete",
                  "description": "æ­¤æ›´æ”¹çš„ä½œç”¨è¯´æ˜",
                  "content": "å®Œæ•´çš„æ–°æ–‡ä»¶å†…å®¹(ç”¨äºcreate/modify)",
                  "old_content": "è¦æ›¿æ¢çš„å†…å®¹(ä»…ç”¨äºmodify)",
                  "new_content": "æ›¿æ¢åçš„å†…å®¹(ä»…ç”¨äºmodify)"
                }
              ],
              "test_suggestions": [
                "å…·ä½“çš„æµ‹è¯•ç”¨ä¾‹å»ºè®®1",
                "å…·ä½“çš„æµ‹è¯•ç”¨ä¾‹å»ºè®®2"
              ],
              "commit_message": "æ¸…æ™°çš„å¸¸è§„æäº¤ä¿¡æ¯",
              "pr_description": "è¯¦ç»†çš„PRæè¿°ï¼Œè§£é‡Šä¿®å¤å†…å®¹",
              "additional_notes": "é‡è¦çš„å®æ–½æ³¨æ„äº‹é¡¹æˆ–è­¦å‘Š"
            }
            
            ## è§„åˆ™è¦æ±‚
            1. ä¸ºä¿®æ”¹æä¾›å®Œæ•´çš„æ–‡ä»¶å†…å®¹
            2. ä½¿ç”¨ç›¸å¯¹äºé¡¹ç›®æ ¹ç›®å½•çš„ç²¾ç¡®æ–‡ä»¶è·¯å¾„
            3. ç¡®ä¿æ‰€æœ‰ä»£ç éµå¾ªé¡¹ç›®çº¦å®š
            4. åŒ…å«é”™è¯¯å¤„ç†å’Œè¾¹ç¼˜æƒ…å†µ
            5. å»ºè®®æœ‰æ„ä¹‰çš„æµ‹è¯•ç”¨ä¾‹
            6. ä¿æŒæ›´æ”¹æœ€å°ä½†å®Œæ•´
            7. æ‰€æœ‰åˆ†æå’Œæè¿°å¿…é¡»ä½¿ç”¨ä¸­æ–‡
            
            åªè¾“å‡ºJSONæ ¼å¼ - ä¸å…è®¸å…¶ä»–æ–‡æœ¬

      # æ­¥éª¤6: ç¡®ä¿ä»mainåˆ†æ”¯åˆ›å»ºä¿®å¤åˆ†æ”¯
      - name: ğŸŒ¿ ä»mainåˆ†æ”¯åˆ›å»ºä¿®å¤åˆ†æ”¯
        id: create_branch
        run: |
          # è·å–æœ€æ–°çš„mainåˆ†æ”¯
          git fetch origin main
          git checkout main
          git pull origin main
          
          # åˆ›å»ºä¿®å¤åˆ†æ”¯
          BRANCH_NAME="fix/issue-${{ inputs.issue_number }}-$(date +%Y%m%d-%H%M%S)"
          echo "branch_name=$BRANCH_NAME" >> $GITHUB_OUTPUT
          
          git checkout -b "$BRANCH_NAME"
          echo "âœ… ä»mainåˆ†æ”¯åˆ›å»ºä¿®å¤åˆ†æ”¯: $BRANCH_NAME"

      # æ­¥éª¤7: è§£æAIä¿®å¤æ–¹æ¡ˆå¹¶è‡ªåŠ¨ä¿®æ”¹ä»£ç 
      - name: ğŸ¤– è‡ªåŠ¨åº”ç”¨ä»£ç ä¿®å¤
        id: apply_fixes
        env:
          AI_RESPONSE: ${{ steps.ai_fix_analysis.outputs.summary }}
        uses: actions/github-script@v6
        with:
          script: |-
            const fs = require('fs');
            const path = require('path');
            
            const aiResponse = process.env.AI_RESPONSE;
            
            core.info(`ğŸ¤– AIåˆ†æç»“æœ: ${aiResponse}`);
            
            let fixPlan;
            let cleanedOutput = aiResponse;
            
            // æ¸…ç†JSONè¾“å‡º
            if (cleanedOutput) {
              cleanedOutput = cleanedOutput.replace(/```json\s*/g, '').replace(/```\s*/g, '');
              cleanedOutput = cleanedOutput.trim();
              if (!cleanedOutput.startsWith('{')) {
                const jsonMatch = cleanedOutput.match(/\{[\s\S]*\}/);
                if (jsonMatch) {
                  cleanedOutput = jsonMatch[0];
                }
              }
            }
            
            try {
              fixPlan = JSON.parse(cleanedOutput);
              core.info(`âœ… æˆåŠŸè§£æä¿®å¤æ–¹æ¡ˆ`);
            } catch (error) {
              core.setFailed(`âŒ JSONè§£æå¤±è´¥: ${error.message}`);
              return;
            }
            
            // éªŒè¯å¿…è¦å­—æ®µ
            if (!fixPlan.file_modifications || !Array.isArray(fixPlan.file_modifications)) {
              core.setFailed('âŒ AIå“åº”ç¼ºå°‘file_modificationså­—æ®µ');
              return;
            }
            
            let modifiedFiles = [];
            let createdFiles = [];
            let deletedFiles = [];
            
            // å¤„ç†æ¯ä¸ªæ–‡ä»¶ä¿®æ”¹
            for (const mod of fixPlan.file_modifications) {
              const filePath = mod.file_path;
              
              try {
                if (mod.action === 'create') {
                  // åˆ›å»ºæ–°æ–‡ä»¶
                  const dirPath = path.dirname(filePath);
                  if (dirPath !== '.') {
                    fs.mkdirSync(dirPath, { recursive: true });
                  }
                  fs.writeFileSync(filePath, mod.content || '');
                  createdFiles.push(filePath);
                  core.info(`âœ… åˆ›å»ºæ–‡ä»¶: ${filePath}`);
                  
                } else if (mod.action === 'modify') {
                  // ä¿®æ”¹ç°æœ‰æ–‡ä»¶
                  if (fs.existsSync(filePath)) {
                    if (mod.old_content && mod.new_content) {
                      // æ›¿æ¢ç‰¹å®šå†…å®¹
                      let fileContent = fs.readFileSync(filePath, 'utf8');
                      fileContent = fileContent.replace(mod.old_content, mod.new_content);
                      fs.writeFileSync(filePath, fileContent);
                    } else if (mod.content) {
                      // å®Œå…¨æ›¿æ¢æ–‡ä»¶å†…å®¹
                      fs.writeFileSync(filePath, mod.content);
                    }
                    modifiedFiles.push(filePath);
                    core.info(`âœ… ä¿®æ”¹æ–‡ä»¶: ${filePath}`);
                  } else {
                    core.warning(`âš ï¸ è¦ä¿®æ”¹çš„æ–‡ä»¶ä¸å­˜åœ¨: ${filePath}`);
                  }
                  
                } else if (mod.action === 'delete') {
                  // åˆ é™¤æ–‡ä»¶
                  if (fs.existsSync(filePath)) {
                    fs.unlinkSync(filePath);
                    deletedFiles.push(filePath);
                    core.info(`âœ… åˆ é™¤æ–‡ä»¶: ${filePath}`);
                  } else {
                    core.warning(`âš ï¸ è¦åˆ é™¤çš„æ–‡ä»¶ä¸å­˜åœ¨: ${filePath}`);
                  }
                }
              } catch (error) {
                core.error(`âŒ å¤„ç†æ–‡ä»¶ ${filePath} æ—¶å‡ºé”™: ${error.message}`);
              }
            }
            
            // è®¾ç½®è¾“å‡ºå˜é‡
            core.setOutput('modified_files', modifiedFiles.join(','));
            core.setOutput('created_files', createdFiles.join(','));
            core.setOutput('deleted_files', deletedFiles.join(','));
            core.setOutput('commit_message', fixPlan.commit_message || `fix: resolve issue #${{ inputs.issue_number }}`);
            core.setOutput('pr_description', fixPlan.pr_description || '');
            core.setOutput('analysis', JSON.stringify(fixPlan.analysis || {}));
            core.setOutput('test_suggestions', JSON.stringify(fixPlan.test_suggestions || []));
            core.setOutput('additional_notes', fixPlan.additional_notes || '');
            
            const totalChanges = modifiedFiles.length + createdFiles.length + deletedFiles.length;
            core.info(`ğŸ¯ ä¿®å¤å®Œæˆ: ä¿®æ”¹${modifiedFiles.length}ä¸ªæ–‡ä»¶, åˆ›å»º${createdFiles.length}ä¸ªæ–‡ä»¶, åˆ é™¤${deletedFiles.length}ä¸ªæ–‡ä»¶`);
            
            if (totalChanges === 0) {
              core.warning('âš ï¸ æ²¡æœ‰æ‰¾åˆ°éœ€è¦ä¿®æ”¹çš„æ–‡ä»¶');
            }

      # æ­¥éª¤8: è‡ªåŠ¨æäº¤ä»£ç æ›´æ”¹
      - name: ğŸ“ æäº¤ä»£ç ä¿®æ”¹
        id: commit_changes
        if: steps.apply_fixes.outputs.modified_files != '' || steps.apply_fixes.outputs.created_files != '' || steps.apply_fixes.outputs.deleted_files != ''
        env:
          COMMIT_MESSAGE: ${{ steps.apply_fixes.outputs.commit_message }}
          BRANCH_NAME: ${{ steps.create_branch.outputs.branch_name }}
        run: |
          # æ£€æŸ¥æ˜¯å¦æœ‰å˜æ›´
          if git diff --quiet && git diff --cached --quiet; then
            echo "âš ï¸ æ²¡æœ‰å‘ç°ä»£ç å˜æ›´ï¼Œè·³è¿‡æäº¤"
            exit 0
          fi
          
          # æ·»åŠ æ‰€æœ‰å˜æ›´
          git add .
          
          # æ˜¾ç¤ºå˜æ›´æ¦‚è§ˆ
          echo "ğŸ“Š å˜æ›´æ¦‚è§ˆ:"
          git diff --cached --stat
          
          # æäº¤å˜æ›´
          git commit -m "${COMMIT_MESSAGE}"
          
          # æ¨é€åˆ°è¿œç¨‹åˆ†æ”¯
          git push origin "${BRANCH_NAME}"
          
          echo "âœ… ä»£ç å·²æäº¤å¹¶æ¨é€åˆ°åˆ†æ”¯: ${BRANCH_NAME}"

      # æ­¥éª¤9: åˆ›å»ºPull Request
      - name: ğŸ”„ åˆ›å»ºPull Request
        id: create_pr
        if: steps.commit_changes.outcome == 'success'
        env:
          GITHUB_TOKEN: ${{ steps.generate_token.outputs.token || secrets.GITHUB_TOKEN }}
          BRANCH_NAME: ${{ steps.create_branch.outputs.branch_name }}
          ISSUE_NUMBER: ${{ inputs.issue_number }}
          ISSUE_TITLE: ${{ inputs.issue_title }}
          PR_DESCRIPTION: ${{ steps.apply_fixes.outputs.pr_description }}
          ANALYSIS: ${{ steps.apply_fixes.outputs.analysis }}
          TEST_SUGGESTIONS: ${{ steps.apply_fixes.outputs.test_suggestions }}
          ADDITIONAL_NOTES: ${{ steps.apply_fixes.outputs.additional_notes }}
          MODIFIED_FILES: ${{ steps.apply_fixes.outputs.modified_files }}
          CREATED_FILES: ${{ steps.apply_fixes.outputs.created_files }}
          DELETED_FILES: ${{ steps.apply_fixes.outputs.deleted_files }}
        run: |
          # æ„å»ºPRæè¿°
          cat > /tmp/pr_description.md << 'EOF'
          ## ğŸ¤– AIè‡ªåŠ¨ä¿®å¤: ${{ env.ISSUE_TITLE }}
          
          **ä¿®å¤Issue**: #${{ env.ISSUE_NUMBER }}
          **ä¿®å¤åˆ†æ”¯**: `${{ env.BRANCH_NAME }}`
          **ä¿®å¤æ—¶é—´**: $(date '+%Y-%m-%d %H:%M:%S')
          
          ### ğŸ“‹ é—®é¢˜åˆ†æ
          
          EOF
          
          # æ·»åŠ AIåˆ†æç»“æœ
          if [[ -n "${ANALYSIS}" && "${ANALYSIS}" != "{}" ]]; then
            echo "${ANALYSIS}" | jq -r '
              "**æ ¹æœ¬åŸå› **: " + (.root_cause // "æœªæä¾›") + "\n" +
              "**ä¸¥é‡ç¨‹åº¦**: " + (.severity // "æœªè¯„ä¼°") + "\n" +
              "**å½±å“èŒƒå›´**: " + (.impact_scope // "æœªè¯„ä¼°") + "\n" +
              "**ä¿®å¤ç­–ç•¥**: " + (.fix_strategy // "æœªæä¾›")
            ' >> /tmp/pr_description.md
          fi
          
          # æ·»åŠ å˜æ›´æ–‡ä»¶åˆ—è¡¨
          cat >> /tmp/pr_description.md << 'EOF'
          
          ### ğŸ“ æ–‡ä»¶å˜æ›´
          
          EOF
          
          if [[ -n "${MODIFIED_FILES}" ]]; then
            echo "**ä¿®æ”¹çš„æ–‡ä»¶**:" >> /tmp/pr_description.md
            echo "${MODIFIED_FILES}" | tr ',' '\n' | while read file; do
              [[ -n "$file" ]] && echo "- ğŸ“ \`$file\`" >> /tmp/pr_description.md
            done
            echo "" >> /tmp/pr_description.md
          fi
          
          if [[ -n "${CREATED_FILES}" ]]; then
            echo "**æ–°å»ºçš„æ–‡ä»¶**:" >> /tmp/pr_description.md
            echo "${CREATED_FILES}" | tr ',' '\n' | while read file; do
              [[ -n "$file" ]] && echo "- âœ¨ \`$file\`" >> /tmp/pr_description.md
            done
            echo "" >> /tmp/pr_description.md
          fi
          
          if [[ -n "${DELETED_FILES}" ]]; then
            echo "**åˆ é™¤çš„æ–‡ä»¶**:" >> /tmp/pr_description.md
            echo "${DELETED_FILES}" | tr ',' '\n' | while read file; do
              [[ -n "$file" ]] && echo "- ğŸ—‘ï¸ \`$file\`" >> /tmp/pr_description.md
            done
            echo "" >> /tmp/pr_description.md
          fi
          
          # æ·»åŠ æµ‹è¯•å»ºè®®
          if [[ -n "${TEST_SUGGESTIONS}" && "${TEST_SUGGESTIONS}" != "[]" ]]; then
            cat >> /tmp/pr_description.md << 'EOF'
          ### ğŸ§ª æµ‹è¯•å»ºè®®
          
          EOF
            echo "${TEST_SUGGESTIONS}" | jq -r '.[]' | while read suggestion; do
              [[ -n "$suggestion" ]] && echo "- $suggestion" >> /tmp/pr_description.md
            done
            echo "" >> /tmp/pr_description.md
          fi
          
          # æ·»åŠ æ³¨æ„äº‹é¡¹
          if [[ -n "${ADDITIONAL_NOTES}" ]]; then
            cat >> /tmp/pr_description.md << 'EOF'
          ### âš ï¸ æ³¨æ„äº‹é¡¹
          
          EOF
            echo "${ADDITIONAL_NOTES}" >> /tmp/pr_description.md
            echo "" >> /tmp/pr_description.md
          fi
          
          # æ·»åŠ AIä¿®å¤è¯´æ˜
          cat >> /tmp/pr_description.md << 'EOF'
          
          ### ğŸ¤– AIä¿®å¤è¯´æ˜
          
          - âœ… æ­¤PRç”±AIæ™ºèƒ½åŠ©æ‰‹è‡ªåŠ¨ç”Ÿæˆ
          - ğŸ” AIå·²åˆ†æé—®é¢˜å¹¶å®æ–½äº†ä¿®å¤æ–¹æ¡ˆ
          - ğŸ‘€ **è¯·ä»”ç»†å®¡æŸ¥æ‰€æœ‰ä»£ç æ›´æ”¹**
          - ğŸ§ª å»ºè®®è¿è¡Œæµ‹è¯•ç¡®ä¿ä¿®å¤æœ‰æ•ˆ
          - âœ‹ å¦‚æœ‰ç–‘é—®è¯·åœ¨PRä¸­è¯„è®ºè®¨è®º
          
          ---
          *ğŸ¤– ç”±æ™ºèƒ½é—®é¢˜ä¿®å¤å™¨è‡ªåŠ¨åˆ›å»º | è¯·ä»”ç»†å®¡æŸ¥ååˆå¹¶*
          EOF
          
          # åˆ›å»ºPR
          PR_URL=$(gh pr create \
            --title "ğŸ¤– AIè‡ªåŠ¨ä¿®å¤: ${ISSUE_TITLE}" \
            --body-file /tmp/pr_description.md \
            --head "${BRANCH_NAME}" \
            --base main \
            --label "ai-generated,needs-review" \
            --assignee "@me")
          
          echo "pr_url=$PR_URL" >> $GITHUB_OUTPUT
          echo "âœ… Pull Requestå·²åˆ›å»º: $PR_URL"

      # æ­¥éª¤10: åœ¨Issueä¸­å‘å¸ƒä¿®å¤å®Œæˆé€šçŸ¥
      - name: ğŸ“ å‘å¸ƒä¿®å¤å®Œæˆé€šçŸ¥
        if: steps.create_pr.outcome == 'success'
        env:
          GITHUB_TOKEN: ${{ steps.generate_token.outputs.token || secrets.GITHUB_TOKEN }}
          ISSUE_NUMBER: ${{ inputs.issue_number }}
          PR_URL: ${{ steps.create_pr.outputs.pr_url }}
          BRANCH_NAME: ${{ steps.create_branch.outputs.branch_name }}
          ANALYSIS: ${{ steps.apply_fixes.outputs.analysis }}
          MODIFIED_FILES: ${{ steps.apply_fixes.outputs.modified_files }}
          CREATED_FILES: ${{ steps.apply_fixes.outputs.created_files }}
          DELETED_FILES: ${{ steps.apply_fixes.outputs.deleted_files }}
        run: |
          # æ„å»ºä¿®å¤å®Œæˆé€šçŸ¥
          cat > /tmp/fix_completion.md << 'EOF'
          ## âœ… AIè‡ªåŠ¨ä¿®å¤å·²å®Œæˆï¼
          
          æˆ‘å·²ç»æˆåŠŸåˆ†æäº†è¿™ä¸ªé—®é¢˜å¹¶**è‡ªåŠ¨å®æ–½äº†ä»£ç ä¿®å¤**ï¼
          
          ### ğŸ¯ ä¿®å¤æ¦‚è§ˆ
          
          EOF
          
          # æ·»åŠ æ–‡ä»¶å˜æ›´ç»Ÿè®¡
          MODIFIED_COUNT=$(echo "${MODIFIED_FILES}" | tr ',' '\n' | grep -v '^$' | wc -l)
          CREATED_COUNT=$(echo "${CREATED_FILES}" | tr ',' '\n' | grep -v '^$' | wc -l)
          DELETED_COUNT=$(echo "${DELETED_FILES}" | tr ',' '\n' | grep -v '^$' | wc -l)
          
          echo "- ğŸ“ ä¿®æ”¹äº† **${MODIFIED_COUNT}** ä¸ªæ–‡ä»¶" >> /tmp/fix_completion.md
          echo "- âœ¨ åˆ›å»ºäº† **${CREATED_COUNT}** ä¸ªæ–‡ä»¶" >> /tmp/fix_completion.md
          echo "- ğŸ—‘ï¸ åˆ é™¤äº† **${DELETED_COUNT}** ä¸ªæ–‡ä»¶" >> /tmp/fix_completion.md
          echo "" >> /tmp/fix_completion.md
          
          # æ·»åŠ AIåˆ†ææ‘˜è¦
          if [[ -n "${ANALYSIS}" && "${ANALYSIS}" != "{}" ]]; then
            echo "### ğŸ” é—®é¢˜åˆ†ææ‘˜è¦" >> /tmp/fix_completion.md
            echo "" >> /tmp/fix_completion.md
            echo "${ANALYSIS}" | jq -r '
              if .root_cause then "**æ ¹æœ¬åŸå› **: " + .root_cause + "\n" else "" end +
              if .severity then "**ä¸¥é‡ç¨‹åº¦**: " + .severity + "\n" else "" end +
              if .fix_strategy then "**ä¿®å¤ç­–ç•¥**: " + .fix_strategy + "\n" else "" end
            ' >> /tmp/fix_completion.md
            echo "" >> /tmp/fix_completion.md
          fi
          
          cat >> /tmp/fix_completion.md << 'EOF'
          ### ğŸ”„ Pull Request å·²åˆ›å»º
          
          **PRé“¾æ¥**: ${{ env.PR_URL }}
          **ä¿®å¤åˆ†æ”¯**: `${{ env.BRANCH_NAME }}`
          
          ### ğŸ‘€ ä¸‹ä¸€æ­¥æ“ä½œ
          
          1. **ğŸ” å®¡æŸ¥PR**: ç‚¹å‡»ä¸Šæ–¹é“¾æ¥æŸ¥çœ‹æ‰€æœ‰ä»£ç æ›´æ”¹
          2. **ğŸ§ª è¿è¡Œæµ‹è¯•**: ç¡®ä¿ä¿®å¤æ²¡æœ‰å¼•å…¥æ–°é—®é¢˜
          3. **âœ… åˆå¹¶ä»£ç **: å®¡æŸ¥é€šè¿‡ååˆå¹¶PR
          4. **ğŸ‰ å…³é—­Issue**: ä¿®å¤éªŒè¯æ— è¯¯åå…³é—­æ­¤Issue
          
          ### ğŸ¤– AIä¿®å¤è¯´æ˜
          
          - âœ… **è‡ªåŠ¨åŒ–ä¿®å¤**: AIå·²è‡ªåŠ¨ä¿®æ”¹ä»£ç å¹¶åˆ›å»ºPR
          - ğŸ›¡ï¸ **å®‰å…¨ä¿éšœ**: æ‰€æœ‰æ›´æ”¹éœ€è¦äººå·¥å®¡æŸ¥
          - ğŸ”§ **å³æ—¶å¯ç”¨**: ä¿®å¤å·²å‡†å¤‡å°±ç»ªï¼Œç­‰å¾…å®¡æŸ¥
          - ğŸ“‹ **è¯¦ç»†è®°å½•**: PRä¸­åŒ…å«å®Œæ•´çš„ä¿®å¤è¯´æ˜
          
          > ğŸ’¡ **æç¤º**: è¿™æ˜¯AIè‡ªåŠ¨ç”Ÿæˆçš„ä¿®å¤æ–¹æ¡ˆï¼Œå»ºè®®ä»”ç»†å®¡æŸ¥åå†åˆå¹¶ã€‚å¦‚æœ‰ç–‘é—®è¯·åœ¨PRä¸­è®¨è®ºï¼
          
          ---
          *ğŸ¤– ç”±æ™ºèƒ½é—®é¢˜ä¿®å¤å™¨è‡ªåŠ¨å®Œæˆ | å·²å‡†å¤‡å®¡æŸ¥*
          EOF
          
          # å‘å¸ƒåˆ°Issue
          gh issue comment "${{ env.ISSUE_NUMBER }}" --body-file /tmp/fix_completion.md
          
          echo "âœ… ä¿®å¤å®Œæˆé€šçŸ¥å·²å‘å¸ƒåˆ°Issue"

      # æ­¥éª¤11: å‘å¸ƒåˆ†ææŠ¥å‘Šï¼ˆå¦‚æœPRåˆ›å»ºå¤±è´¥ï¼‰
      - name: ğŸ“ å‘å¸ƒåˆ†ææŠ¥å‘Šï¼ˆå¤‡ç”¨ï¼‰
        if: steps.create_pr.outcome != 'success' && steps.ai_fix_analysis.outputs.summary != ''
        env:
          GITHUB_TOKEN: ${{ steps.generate_token.outputs.token || secrets.GITHUB_TOKEN }}
          ISSUE_NUMBER: ${{ inputs.issue_number }}
          BRANCH_NAME: ${{ steps.create_branch.outputs.branch_name }}
          ANALYSIS: ${{ steps.apply_fixes.outputs.analysis }}
        run: |
          # æ„å»ºåˆ†ææŠ¥å‘Š
          cat > /tmp/analysis_report.md << 'EOF'
          ## ğŸ¤– AIä¿®å¤åˆ†ææŠ¥å‘Š
          
          æˆ‘å·²ç»åˆ†æäº†è¿™ä¸ªé—®é¢˜å¹¶å°è¯•è‡ªåŠ¨ä¿®å¤ï¼Œä½†åœ¨åˆ›å»ºPRæ—¶é‡åˆ°äº†é—®é¢˜ã€‚ä»¥ä¸‹æ˜¯åˆ†æç»“æœï¼š
          
          EOF
          
          # æ·»åŠ åˆ†æç»“æœ
          if [[ -n "${ANALYSIS}" && "${ANALYSIS}" != "{}" ]]; then
            echo "### ğŸ” é—®é¢˜åˆ†æ" >> /tmp/analysis_report.md
            echo "" >> /tmp/analysis_report.md
            echo "${ANALYSIS}" | jq -r '
              if .root_cause then "**æ ¹æœ¬åŸå› **: " + .root_cause + "\n\n" else "" end +
              if .severity then "**ä¸¥é‡ç¨‹åº¦**: " + .severity + "\n\n" else "" end +
              if .impact_scope then "**å½±å“èŒƒå›´**: " + .impact_scope + "\n\n" else "" end +
              if .fix_strategy then "**ä¿®å¤ç­–ç•¥**: " + .fix_strategy + "\n\n" else "" end
            ' >> /tmp/analysis_report.md
          fi
          
          cat >> /tmp/analysis_report.md << 'EOF'
          
          ### ğŸ“‹ æ‰‹åŠ¨æ“ä½œæ­¥éª¤
          
          ç”±äºè‡ªåŠ¨PRåˆ›å»ºå¤±è´¥ï¼Œè¯·æ‰‹åŠ¨å®Œæˆä»¥ä¸‹æ­¥éª¤ï¼š
          
          1. **åˆ‡æ¢åˆ†æ”¯**: `git checkout ${{ env.BRANCH_NAME }}`
          2. **æŸ¥çœ‹æ›´æ”¹**: `git diff main` 
          3. **æ‰‹åŠ¨è°ƒæ•´**: æ ¹æ®AIåˆ†æç»“æœè¿›è¡Œä»£ç ä¿®æ”¹
          4. **æäº¤æ›´æ”¹**: `git add . && git commit -m "fix: resolve issue #${{ env.ISSUE_NUMBER }}"`
          5. **æ¨é€åˆ†æ”¯**: `git push origin ${{ env.BRANCH_NAME }}`
          6. **åˆ›å»ºPR**: åœ¨GitHubç•Œé¢åˆ›å»ºPull Request
          
          ### ğŸ” è¯¦ç»†æ—¥å¿—
          
          å¦‚éœ€æŸ¥çœ‹è¯¦ç»†çš„æ‰§è¡Œæ—¥å¿—ï¼Œè¯·å‚è€ƒ: [Actionæ‰§è¡Œæ—¥å¿—](${{ github.server_url }}/${{ github.repository }}/actions/runs/${{ github.run_id }})
          
          ---
          *ğŸ¤– ç”±æ™ºèƒ½é—®é¢˜ä¿®å¤å™¨ç”Ÿæˆ | éœ€è¦æ‰‹åŠ¨å®Œæˆ*
          EOF
          
          # å‘å¸ƒåˆ°Issue
          gh issue comment "${{ env.ISSUE_NUMBER }}" --body-file /tmp/analysis_report.md
          
          echo "âœ… åˆ†ææŠ¥å‘Šå·²å‘å¸ƒåˆ°Issue"

      # æ­¥éª¤12: æ›´æ–°Issueæ ‡ç­¾
      - name: ğŸ·ï¸ æ›´æ–°Issueæ ‡ç­¾
        if: always()
        env:
          GITHUB_TOKEN: ${{ steps.generate_token.outputs.token || secrets.GITHUB_TOKEN }}
          ISSUE_NUMBER: ${{ inputs.issue_number }}
          PR_SUCCESS: ${{ steps.create_pr.outcome == 'success' }}
        run: |
          if [[ "${PR_SUCCESS}" == "true" ]]; then
            # PRåˆ›å»ºæˆåŠŸï¼Œæ·»åŠ ç›¸åº”æ ‡ç­¾
            gh issue edit "${{ env.ISSUE_NUMBER }}" --add-label "ai-fixed,needs-review" --remove-label "needs-fix" || true
            echo "âœ… Issueæ ‡ç­¾å·²æ›´æ–°: ai-fixed, needs-review"
          else
            # PRåˆ›å»ºå¤±è´¥æˆ–æœªæ‰§è¡Œï¼Œæ·»åŠ åˆ†æå®Œæˆæ ‡ç­¾
            gh issue edit "${{ env.ISSUE_NUMBER }}" --add-label "ai-analyzed,needs-manual-fix" || true
            echo "âœ… Issueæ ‡ç­¾å·²æ›´æ–°: ai-analyzed, needs-manual-fix"
          fi

      # æ­¥éª¤13: å¤±è´¥å¤„ç†
      - name: âŒ AIä¿®å¤å¤±è´¥å¤„ç†
        if: failure()
        env:
          GITHUB_TOKEN: ${{ steps.generate_token.outputs.token || secrets.GITHUB_TOKEN }}
          ISSUE_NUMBER: ${{ inputs.issue_number }}
        run: |
          # å‘å¸ƒå¤±è´¥é€šçŸ¥
          cat > /tmp/failure_notice.md << 'EOF'
          ## âŒ AIè‡ªåŠ¨ä¿®å¤å¤±è´¥
          
          å¾ˆæŠ±æ­‰ï¼ŒAIä¿®å¤è¿‡ç¨‹ä¸­é‡åˆ°äº†é—®é¢˜ã€‚å¯èƒ½çš„åŸå› ï¼š
          
          ### ğŸ” å¸¸è§åŸå› 
          1. **é—®é¢˜æè¿°ä¸å¤Ÿè¯¦ç»†** - ç¼ºå°‘é”™è¯¯ä¿¡æ¯ã€ä»£ç ç‰‡æ®µæˆ–å¤ç°æ­¥éª¤
          2. **ä»£ç åº“å¤æ‚åº¦è¿‡é«˜** - é¡¹ç›®ç»“æ„å¤æ‚ï¼ŒAIéš¾ä»¥å‡†ç¡®åˆ†æ
          3. **APIæœåŠ¡é—®é¢˜** - Gemini APIæš‚æ—¶ä¸å¯ç”¨æˆ–é…ç½®é”™è¯¯
          4. **æƒé™é™åˆ¶** - GitHubæƒé™ä¸è¶³ï¼Œæ— æ³•ä¿®æ”¹ä»£ç æˆ–åˆ›å»ºPR
          
          ### ğŸ› ï¸ å»ºè®®æ“ä½œ
          
          #### ç«‹å³å¯ä»¥å°è¯•ï¼š
          - ğŸ“ **è¡¥å……é—®é¢˜æè¿°**: æ·»åŠ æ›´å¤šé”™è¯¯æ—¥å¿—ã€ä»£ç ç‰‡æ®µã€å¤ç°æ­¥éª¤
          - ğŸ”„ **é‡è¯•ä¿®å¤**: ä½¿ç”¨ `@abc fix this issue` é‡æ–°è§¦å‘
          - ğŸ“‹ **ç®€åŒ–é—®é¢˜**: å°†å¤æ‚é—®é¢˜æ‹†åˆ†ä¸ºå¤šä¸ªå°é—®é¢˜
          
          #### æ‰‹åŠ¨ä¿®å¤ï¼š
          - ğŸ‘¨â€ğŸ’» **æŸ¥çœ‹æ—¥å¿—**: [è¯¦ç»†æ‰§è¡Œæ—¥å¿—](${{ github.server_url }}/${{ github.repository }}/actions/runs/${{ github.run_id }})
          - ğŸ”§ **æ‰‹åŠ¨åˆ†æ**: åŸºäºé—®é¢˜æè¿°è¿›è¡Œäººå·¥åˆ†æ
          - ğŸ’¡ **è¯·æ±‚å¸®åŠ©**: @æåŠå›¢é˜Ÿæˆå‘˜å¯»æ±‚æ”¯æŒ
          
          ### ğŸ¤– AIåŠ©æ‰‹å…¶ä»–åŠŸèƒ½
          
          å³ä½¿è‡ªåŠ¨ä¿®å¤å¤±è´¥ï¼Œæ‚¨ä»å¯ä»¥ä½¿ç”¨ï¼š
          - `@abc åˆ†æè¿™ä¸ªé—®é¢˜çš„åŸå› ` - è·å–é—®é¢˜åˆ†æ
          - `@abc ç»™å‡ºä¿®å¤å»ºè®®` - è·å–ä¿®å¤æŒ‡å¯¼
          - `@abc å¦‚ä½•é‡ç°è¿™ä¸ªé—®é¢˜` - è·å–è°ƒè¯•å»ºè®®
          
          ---
          *ğŸ¤– ç”±æ™ºèƒ½é—®é¢˜ä¿®å¤å™¨ç”Ÿæˆ | å¯ä»¥é‡è¯•æˆ–æ‰‹åŠ¨å¤„ç†*
          EOF
          
          gh issue comment "${{ env.ISSUE_NUMBER }}" --body-file /tmp/failure_notice.md
          
          # æ·»åŠ å¤±è´¥æ ‡ç­¾
          gh issue edit "${{ env.ISSUE_NUMBER }}" --add-label "ai-fix-failed,needs-help" || true
          
          echo "âœ… å¤±è´¥é€šçŸ¥å·²å‘å¸ƒåˆ°Issue"

# ===============================================
# ğŸ“‹ ä½¿ç”¨è¯´æ˜
# ===============================================
#
# ğŸ¯ è§¦å‘æ–¹å¼ï¼š
#   åœ¨Issueæˆ–PRè¯„è®ºä¸­ä½¿ç”¨: @abc fix this issue
#
# ğŸ¤– å…¨è‡ªåŠ¨ä¿®å¤æµç¨‹ï¼š
#   1. ä»mainåˆ†æ”¯æ‹‰å–æœ€æ–°ä»£ç 
#   2. AIåˆ†æé—®é¢˜å¹¶ç”Ÿæˆä¿®å¤æ–¹æ¡ˆ
#   3. è‡ªåŠ¨ä¿®æ”¹/åˆ›å»º/åˆ é™¤ä»£ç æ–‡ä»¶
#   4. è‡ªåŠ¨æäº¤ä»£ç æ›´æ”¹
#   5. è‡ªåŠ¨åˆ›å»ºPull Request
#   6. åœ¨Issueä¸­å‘å¸ƒä¿®å¤å®Œæˆé€šçŸ¥
#
# ğŸ“Š AIåˆ†æèƒ½åŠ›ï¼š
#   - ğŸ” é—®é¢˜æ ¹å› åˆ†æ
#   - ğŸ“‹ ä¿®å¤ç­–ç•¥åˆ¶å®š
#   - ğŸ’» è‡ªåŠ¨ä»£ç ç”Ÿæˆ
#   - ğŸ§ª æµ‹è¯•ç”¨ä¾‹å»ºè®®
#   - ğŸ“ è¯¦ç»†ä¿®å¤æ–‡æ¡£
#
# ğŸ”§ æ”¯æŒçš„ä¿®å¤ç±»å‹ï¼š
#   - bug: Bugä¿®å¤å’Œé”™è¯¯å¤„ç†
#   - performance: æ€§èƒ½ä¼˜åŒ–å’Œæ”¹è¿›
#   - security: å®‰å…¨æ¼æ´ä¿®å¤
#   - enhancement: åŠŸèƒ½å¢å¼ºå’Œæ‰©å±•
#
# âš¡ å…¨è‡ªåŠ¨åŒ–åŠŸèƒ½ï¼š
#   - âœ… è‡ªåŠ¨ä»£ç ä¿®æ”¹ (å¢åˆ æ”¹æŸ¥)
#   - ğŸŒ¿ è‡ªåŠ¨åˆ†æ”¯åˆ›å»º (ä»mainæ‹‰å–)
#   - ğŸ“ è‡ªåŠ¨ä»£ç æäº¤å’Œæ¨é€
#   - ğŸ”„ è‡ªåŠ¨PRåˆ›å»º (ç­‰å¾…å®¡æŸ¥)
#   - ğŸ·ï¸ æ™ºèƒ½æ ‡ç­¾ç®¡ç†
#   - ğŸ“‹ è¯¦ç»†ä¿®å¤æŠ¥å‘Š
#   - ğŸ›¡ï¸ å®‰å…¨å®¡æŸ¥æœºåˆ¶
#
# ğŸ¯ å®Œæ•´ç¤ºä¾‹ï¼š
#   ç”¨æˆ·: "@abc fix this issue"
#   AI: 
#   1. åˆ†æIssueä¸­çš„é”™è¯¯æè¿°
#   2. æ‰«æé¡¹ç›®ä»£ç ç»“æ„
#   3. è‡ªåŠ¨ä¿®æ”¹ç›¸å…³æ–‡ä»¶
#   4. æäº¤å¹¶æ¨é€ä¿®å¤
#   5. åˆ›å»ºPRç­‰å¾…å®¡æŸ¥
#   6. åœ¨Issueä¸­æŠ¥å‘Šå®ŒæˆçŠ¶æ€
#
# ğŸ›¡ï¸ å®‰å…¨ä¿éšœï¼š
#   - æ‰€æœ‰ä»£ç æ›´æ”¹éœ€è¦äººå·¥å®¡æŸ¥
#   - PRåŒ…å«è¯¦ç»†çš„ä¿®å¤è¯´æ˜
#   - æ™ºèƒ½æ ‡ç­¾æ ‡è¯†AIç”Ÿæˆå†…å®¹
#   - å®Œæ•´çš„å˜æ›´è¿½è¸ªå’Œæ—¥å¿—
#
# ===============================================
