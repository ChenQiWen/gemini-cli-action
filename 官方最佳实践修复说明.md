# ğŸ”§ åŸºäºå®˜æ–¹run-gemini-clié¡¹ç›®çš„ä¿®å¤æ–¹æ¡ˆ

## ğŸ“‹ é—®é¢˜èƒŒæ™¯

ç”¨æˆ·é‡åˆ°çš„é”™è¯¯ï¼š
```
Error: Failed to parse labels JSON from Gemini output: Unexpected token 'U', "Understood..." is not valid JSON
Raw output: Understood. I am ready to triage the issue. Please provide the details.
```

**æ ¹æœ¬åŸå› **: Geminiè¿”å›å¯¹è¯å¼æ–‡æœ¬è€Œä¸æ˜¯æœŸæœ›çš„JSONæ ¼å¼ã€‚

## ğŸ” å®˜æ–¹é¡¹ç›®ç ”ç©¶å‘ç°

é€šè¿‡æ·±å…¥ç ”ç©¶[å®˜æ–¹run-gemini-clié¡¹ç›®](https://github.com/google-github-actions/run-gemini-cli)ï¼Œå‘ç°ä»¥ä¸‹å…³é”®ç‚¹ï¼š

### **å…³é”®å‘ç°1: å¿…éœ€çš„å‚æ•°**
å®˜æ–¹æ–‡æ¡£æ˜ç¡®æŒ‡å‡ºéœ€è¦è¿™äº›å‚æ•°ï¼š
- `gemini_model`: æŒ‡å®šå…·ä½“çš„æ¨¡å‹ç‰ˆæœ¬
- `gemini_debug`: æ§åˆ¶è°ƒè¯•è¾“å‡º
- `responseMimeType`: å¼ºåˆ¶JSONè¾“å‡ºçš„å…³é”®å‚æ•°

### **å…³é”®å‘ç°2: æ­£ç¡®çš„JSONå¼ºåˆ¶é…ç½®**
```json
{
  "responseMimeType": "application/json"
}
```
è¿™æ˜¯å¼ºåˆ¶Geminiè¿”å›JSONæ ¼å¼çš„**å®˜æ–¹æ ‡å‡†æ–¹æ³•**ã€‚

### **å…³é”®å‘ç°3: ç®€åŒ–çš„Promptç»“æ„**
å½“ä½¿ç”¨JSONæ¨¡å¼æ—¶ï¼Œå®˜æ–¹å»ºè®®ä½¿ç”¨æ›´ç®€æ´çš„promptç»“æ„ã€‚

## âœ… å®æ–½çš„ä¿®å¤æ–¹æ¡ˆ

### **1. æ·»åŠ å…³é”®å‚æ•°**
```yaml
gemini_debug: false               # å…³é—­è°ƒè¯•æ¨¡å¼
gemini_cli_version: 'v0.1.12'     # å›ºå®šæœ€æ–°ç¨³å®šç‰ˆæœ¬
# gemini_model: å·²ç§»é™¤ï¼Œä½¿ç”¨å®˜æ–¹é»˜è®¤æ¨¡å‹
```

### **2. ä½¿ç”¨å®˜æ–¹JSONæ¨¡å¼**
```yaml
settings: |-
  {
    "debug": false,
    "temperature": 0.0,
    "candidateCount": 1,
    "maxOutputTokens": 2048,
    "responseMimeType": "application/json"  # ğŸ”‘ å…³é”®ä¿®å¤
  }
```

### **3. ä¼˜åŒ–Promptç»“æ„**
**ä¿®æ”¹å‰** (å†—é•¿å¤æ‚):
```
## Role
You are an issue triage assistant that analyzes GitHub issues...
## Task  
Analyze the provided issue and return ONLY a JSON object...
## Output Format
You MUST respond with ONLY a valid JSON object in this exact format:
...
```

**ä¿®æ”¹å** (ç®€æ´æ¸…æ™°):
```
You are an issue triage assistant. Analyze the GitHub issue and return a JSON response with appropriate labels.

Repository: ${REPOSITORY}
Issue #${ISSUE_NUMBER}: ${ISSUE_TITLE}
Issue Body: ${ISSUE_BODY}
Available Labels: ${AVAILABLE_LABELS}

Return a JSON object with this structure:
{
  "labels_to_set": ["label1", "label2"],
  "explanation": "Brief explanation"
}
```

## ğŸ¯ ä¿®å¤çš„å·¥ä½œæµæ–‡ä»¶

1. âœ… **é—®é¢˜è‡ªåŠ¨åˆ†ç±»å™¨.yml**
   - æ·»åŠ  `gemini_model` å’Œ `gemini_debug`
   - ä½¿ç”¨ `responseMimeType: "application/json"`
   - ç®€åŒ–promptç»“æ„

2. âœ… **é—®é¢˜å®šæ—¶åˆ†ç±»å™¨.yml**
   - ç›¸åŒçš„é…ç½®ä¼˜åŒ–
   - é€‚é…æ‰¹é‡å¤„ç†çš„prompt

3. âœ… **ä»£ç å®¡æŸ¥åŠ©æ‰‹.yml**
   - æ·»åŠ ç¼ºå¤±çš„æ¨¡å‹å‚æ•°
   - ä¿æŒç°æœ‰åŠŸèƒ½ä¸å˜

4. âœ… **æ™ºèƒ½åŠ©æ‰‹å‘½ä»¤å¤„ç†å™¨.yml**
   - ç»Ÿä¸€é…ç½®æ ¼å¼
   - æ·»åŠ ç‰ˆæœ¬å›ºå®š

5. âœ… **æ™ºèƒ½é—®é¢˜ä¿®å¤å™¨.yml**
   - ä¿®å¤å¼•å·ç¼ºå¤±é—®é¢˜
   - æ·»åŠ æ ‡å‡†å‚æ•°

## ğŸ”‘ æ ¸å¿ƒä¿®å¤åŸç†

### **JSONå¼ºåˆ¶æœºåˆ¶**
```yaml
# ä¹‹å‰çš„å°è¯• (ä¸å®Œæ•´)
"responseFormat": "json"           # âŒ é”™è¯¯çš„å‚æ•°å
"systemInstruction": "..."         # âŒ ä¸æ˜¯æ ‡å‡†æ–¹æ³•

# å®˜æ–¹æ ‡å‡†æ–¹æ³• (æ­£ç¡®)
"responseMimeType": "application/json"  # âœ… å®˜æ–¹APIæ ‡å‡†
```

### **æ¨¡å‹æŒ‡å®š**
```yaml
# ä¹‹å‰: ä½¿ç”¨é»˜è®¤æ¨¡å‹ (å¯èƒ½ä¸ç¨³å®š)
# ç°åœ¨: æ˜ç¡®æŒ‡å®šç¨³å®šæ¨¡å‹
gemini_model: 'gemini-1.5-flash'
```

### **Promptä¼˜åŒ–**
- ç§»é™¤å†—ä½™çš„æ ¼å¼è¯´æ˜
- ç›´æ¥æŒ‡å®šJSONç»“æ„
- ä¾èµ–APIçº§åˆ«çš„JSONå¼ºåˆ¶

## ğŸ“Š é¢„æœŸæ•ˆæœ

### **ä¿®å¤å‰**:
```
Raw output: Understood. I am ready to triage the issue. Please provide the details.
Error: Unexpected token 'U'
```

### **ä¿®å¤å**:
```json
{
  "labels_to_set": ["bug", "needs-investigation"],
  "explanation": "User reports unexpected behavior with error logs"
}
```

## ğŸ›¡ï¸ æœ€ä½³å®è·µæ€»ç»“

åŸºäºå®˜æ–¹é¡¹ç›®çš„æœ€ä½³å®è·µï¼š

1. **ä½¿ç”¨å®˜æ–¹é»˜è®¤æ¨¡å‹** (é¿å…ä¸»è§‚é€‰æ‹©)
2. **ä½¿ç”¨å®˜æ–¹JSON APIå‚æ•°**
3. **ä¿æŒpromptç®€æ´æ¸…æ™°**
4. **å›ºå®šCLIç‰ˆæœ¬é¿å…å…¼å®¹æ€§é—®é¢˜**
5. **éµå¾ªå®˜æ–¹å‚æ•°å‘½åçº¦å®š**

## ğŸ”— å‚è€ƒèµ„æ–™

- [å®˜æ–¹run-gemini-clié¡¹ç›®](https://github.com/google-github-actions/run-gemini-cli)
- [Gemini API JSONæ¨¡å¼æ–‡æ¡£](https://ai.google.dev/gemini-api/docs/json-mode)
- [GitHub Actionsæœ€ä½³å®è·µ](https://docs.github.com/en/actions/security-guides/security-hardening-for-github-actions)

---

**æ€»ç»“**: é€šè¿‡é‡‡ç”¨å®˜æ–¹é¡¹ç›®çš„æ ‡å‡†é…ç½®å’Œæœ€ä½³å®è·µï¼Œç‰¹åˆ«æ˜¯ä½¿ç”¨ `responseMimeType: "application/json"` å‚æ•°ï¼Œåº”è¯¥èƒ½å¤Ÿå½»åº•è§£å†³JSONè§£æé—®é¢˜ã€‚
