# å·¥ä½œæµåç§°
name: 'ğŸ¤– æ™ºèƒ½åŠ©æ‰‹å‘½ä»¤å¤„ç†å™¨ - å¤„ç†ç”¨æˆ·è¯·æ±‚å’Œå‘½ä»¤çš„æ ¸å¿ƒå·¥ä½œæµ'

# è§¦å‘æ¡ä»¶ï¼šå®šä¹‰ä¸ºå¯è¢«å…¶ä»–å·¥ä½œæµè°ƒç”¨
on:
  workflow_call:
    # å®šä¹‰è¾“å…¥å‚æ•°
    inputs:
      user_request:
        description: 'ä»è¯„è®ºæˆ– Issue æ­£æ–‡ä¸­æå–çš„ç”¨æˆ·è¯·æ±‚æ–‡æœ¬'
        required: true
        type: string
      issue_number:
        description: 'å…³è”çš„ Issue æˆ– PR ç¼–å·'
        required: true
        type: number
      is_pr:
        description: 'ä¸Šä¸‹æ–‡æ˜¯å¦ä¸ºä¸€ä¸ª Pull Request (true/false)'
        required: true
        type: boolean
    # å®šä¹‰æ‰€éœ€å¯†é’¥
    secrets:
      APP_PRIVATE_KEY:
        description: 'GitHub App çš„ç§é’¥'
        required: false
      GEMINI_API_KEY:
        description: 'Gemini API çš„å¯†é’¥'
        required: false

# å¹¶å‘æ§åˆ¶ï¼šç¡®ä¿å¯¹åŒä¸€ä¸ª Issue/PR çš„å¤„ç†ä¸ä¼šé‡å¤æ‰§è¡Œ
concurrency:
  group: '${{ github.workflow }}-${{ inputs.issue_number }}'
  cancel-in-progress: true

# é»˜è®¤è®¾ç½®
defaults:
  run:
    shell: 'bash'

# æƒé™è®¾ç½®
permissions:
  contents: 'write'      # éœ€è¦å†™å…¥æƒé™æ¥æäº¤ä»£ç ä¿®æ”¹
  id-token: 'write'
  pull-requests: 'write'
  issues: 'write'

# ä½œä¸šå®šä¹‰
jobs:
  gemini-cli:
    # è°ƒç”¨æ–¹è´Ÿè´£æ§åˆ¶æ‰§è¡Œé€»è¾‘ï¼Œæ•…ç§»é™¤ 'if' æ¡ä»¶
    timeout-minutes: 10
    runs-on: 'ubuntu-latest'
    
    # ä½œä¸šæ­¥éª¤
    steps:
      # æ­¥éª¤1: (å¯é€‰) ç”Ÿæˆ GitHub App Token
      - name: 'Generate GitHub App Token'
        id: 'generate_token'
        if: ${{ vars.APP_ID != '' }}
        uses: 'actions/create-github-app-token@v2'
        with:
          app-id: '${{ vars.APP_ID }}'
          private-key: '${{ secrets.APP_PRIVATE_KEY }}'

      # æ­¥éª¤2: ä»è°ƒç”¨æ–¹ä¼ å…¥çš„ inputs ä¸­è®¾ç½®ä¸Šä¸‹æ–‡ä¿¡æ¯
      - name: 'Set context from inputs'
        id: 'get_context'
        run: |-
          echo "user_request=${{ inputs.user_request }}" >> "${GITHUB_OUTPUT}"
          echo "issue_number=${{ inputs.issue_number }}" >> "${GITHUB_OUTPUT}"
          echo "is_pr=${{ inputs.is_pr }}" >> "${GITHUB_OUTPUT}"

      # æ­¥éª¤3: è®¾ç½® Git æäº¤è€…ä¿¡æ¯
      - name: 'Set up git user for commits'
        run: |-
          git config --global user.name 'gemini-cli[bot]'
          git config --global user.email 'gemini-cli[bot]@users.noreply.github.com'

      # æ­¥éª¤4: å¦‚æœæ˜¯ PRï¼Œæ£€å‡º PR æ‰€åœ¨çš„åˆ†æ”¯
      - name: 'Checkout PR branch'
        if: steps.get_context.outputs.is_pr == 'true'
        uses: 'actions/checkout@v4'
        with:
          token: '${{ steps.generate_token.outputs.token || secrets.GITHUB_TOKEN }}'
          repository: '${{ github.repository }}'
          ref: 'refs/pull/${{ steps.get_context.outputs.issue_number }}/head'
          fetch-depth: 0

      # æ­¥éª¤5: å¦‚æœæ˜¯ Issueï¼Œæ£€å‡ºé»˜è®¤ä¸»åˆ†æ”¯
      - name: 'Checkout main branch'
        if: steps.get_context.outputs.is_pr == 'false'
        uses: 'actions/checkout@v4'
        with:
          token: '${{ steps.generate_token.outputs.token || secrets.GITHUB_TOKEN }}'
          repository: '${{ github.repository }}'
          fetch-depth: 0

      # æ­¥éª¤6: åœ¨ Issue/PR ä¸‹å‘è¡¨è¯„è®ºï¼Œå‘ŠçŸ¥ç”¨æˆ·å·²å¼€å§‹å¤„ç†
      - name: 'Acknowledge request'
        env:
          GITHUB_ACTOR: '${{ github.actor }}'
          GITHUB_TOKEN: '${{ steps.generate_token.outputs.token || secrets.GITHUB_TOKEN }}'
          ISSUE_NUMBER: '${{ steps.get_context.outputs.issue_number }}'
          REPOSITORY: '${{ github.repository }}'
        run: |-
          set -euo pipefail
          MESSAGE="@${GITHUB_ACTOR} æˆ‘å·²æ”¶åˆ°æ‚¨çš„è¯·æ±‚ï¼Œæ­£åœ¨å¤„ç†ä¸­ï¼ğŸ¤–"
          gh issue comment "${ISSUE_NUMBER}" --body "${MESSAGE}" --repo "${REPOSITORY}"

      # æ­¥éª¤7: è·å– Issue æˆ– PR çš„æè¿°æ­£æ–‡
      - name: 'Get description'
        id: 'get_description'
        env:
          GITHUB_TOKEN: '${{ steps.generate_token.outputs.token || secrets.GITHUB_TOKEN }}'
          IS_PR: '${{ steps.get_context.outputs.is_pr }}'
          ISSUE_NUMBER: '${{ steps.get_context.outputs.issue_number }}'
        run: |-
          set -euo pipefail
          if [[ "${IS_PR}" == "true" ]]; then
            DESCRIPTION=$(gh pr view "${ISSUE_NUMBER}" --json body --template '{{.body}}')
          else
            DESCRIPTION=$(gh issue view "${ISSUE_NUMBER}" --json body --template '{{.body}}')
          fi
          {
            echo "description<<EOF"
            echo "${DESCRIPTION}"
            echo "EOF"
          } >> "${GITHUB_OUTPUT}"

      # æ­¥éª¤8: è·å– Issue æˆ– PR çš„æ‰€æœ‰è¯„è®º
      - name: 'Get comments'
        id: 'get_comments'
        env:
          GITHUB_TOKEN: '${{ steps.generate_token.outputs.token || secrets.GITHUB_TOKEN }}'
          IS_PR: '${{ steps.get_context.outputs.is_pr }}'
          ISSUE_NUMBER: '${{ steps.get_context.outputs.issue_number }}'
        run: |-
          set -euo pipefail
          if [[ "${IS_PR}" == "true" ]]; then
            COMMENTS=$(gh pr view "${ISSUE_NUMBER}" --json comments --template '{{range .comments}}{{.author.login}}: {{.body}}{{"\n"}}{{end}}')
          else
            COMMENTS=$(gh issue view "${ISSUE_NUMBER}" --json comments --template '{{range .comments}}{{.author.login}}: {{.body}}{{"\n"}}{{end}}')
          fi
          {
            echo "comments<<EOF"
            echo "${COMMENTS}"
            echo "EOF"
          } >> "${GITHUB_OUTPUT}"

      # æ­¥éª¤9: è¿è¡Œ Gemini CLI æ ¸å¿ƒé€»è¾‘
      - name: 'Run Gemini'
        id: 'run_gemini'
        uses: 'google-github-actions/run-gemini-cli@v0.1.12'
        env:
          # å°†å‰é¢æ‰€æœ‰æ­¥éª¤æ”¶é›†åˆ°çš„ä¸Šä¸‹æ–‡ä¿¡æ¯ä¼ é€’ç»™ Gemini
          GITHUB_TOKEN: '${{ steps.generate_token.outputs.token || secrets.GITHUB_TOKEN }}'
          REPOSITORY: '${{ github.repository }}'
          USER_REQUEST: '${{ steps.get_context.outputs.user_request }}'
          ISSUE_NUMBER: '${{ steps.get_context.outputs.issue_number }}'
          IS_PR: '${{ steps.get_context.outputs.is_pr }}'
        with:
          # Gemini CLI é…ç½®
          gemini_cli_version: 'v0.1.12'  # ä½¿ç”¨æœ€æ–°ç¨³å®šç‰ˆæœ¬
          gemini_api_key: '${{ secrets.GEMINI_API_KEY }}'
          gemini_debug: false  # å…³é—­è°ƒè¯•æ¨¡å¼
          gcp_workload_identity_provider: '${{ vars.GCP_WIF_PROVIDER }}'
          gcp_project_id: '${{ vars.GOOGLE_CLOUD_PROJECT }}'
          gcp_location: '${{ vars.GOOGLE_CLOUD_LOCATION }}'
          gcp_service_account: '${{ vars.SERVICE_ACCOUNT_EMAIL }}'
          use_vertex_ai: '${{ vars.GOOGLE_GENAI_USE_VERTEXAI }}'
          use_gemini_code_assist: '${{ vars.GOOGLE_GENAI_USE_GCA }}'
          settings: |-
            {
              "debug": false,
              "temperature": 0.3,
              "candidateCount": 1,
              "maxOutputTokens": 2048,
              "responseMimeType": "application/json",
              "systemInstruction": "You are a helpful AI assistant that responds with valid JSON format containing your analysis and suggestions."
            }
          prompt: |-
            IMPORTANT: Respond ONLY with valid JSON. No conversational text.
            
            You are an intelligent AI assistant helping with GitHub project management and development tasks.
            
            User Request: ${USER_REQUEST}
            Repository: ${REPOSITORY}
            Issue/PR Number: ${ISSUE_NUMBER}
            Is Pull Request: ${IS_PR}
            Issue/PR Description: ${{ steps.get_description.outputs.description }}
            Recent Comments: ${{ steps.get_comments.outputs.comments }}
            
            CAPABILITIES:
            - Code analysis and suggestions
            - Project planning and task breakdown
            - Development best practices advice
            - Bug investigation and solutions
            - Feature implementation guidance
            - Code review and optimization
            - Documentation improvement
            - Architecture recommendations
            
            RESPONSE FORMAT (JSON only):
            {
              "analysis": "Brief analysis of the request and context",
              "suggestions": [
                "Specific actionable suggestion 1",
                "Specific actionable suggestion 2",
                "Specific actionable suggestion 3"
              ],
              "implementation_steps": [
                "Step 1: Detailed implementation step",
                "Step 2: Detailed implementation step"
              ],
              "code_examples": "Relevant code examples if applicable",
              "additional_resources": "Links or resources if helpful",
              "priority": "high|medium|low",
              "estimated_effort": "Brief effort estimate"
            }
            
            RULES:
            - Provide practical, actionable advice
            - Be specific and detailed in suggestions
            - Consider the project context and existing code
            - Focus on best practices and maintainability
            - If it's a bug, provide debugging steps
            - If it's a feature request, provide implementation approach
            - If it's optimization, explain the benefits and approach

      # æ­¥éª¤10: å¤„ç†Geminiè¾“å‡ºå¹¶å›å¤ç”¨æˆ·
      - name: 'Process AI Response and Reply'
        env:
          GITHUB_TOKEN: '${{ steps.generate_token.outputs.token || secrets.GITHUB_TOKEN }}'
          ISSUE_NUMBER: '${{ steps.get_context.outputs.issue_number }}'
          REPOSITORY: '${{ github.repository }}'
          GEMINI_OUTPUT: '${{ steps.run_gemini.outputs.summary }}'
          USER_REQUEST: '${{ steps.get_context.outputs.user_request }}'
        uses: 'actions/github-script@v6'
        with:
          github-token: '${{ env.GITHUB_TOKEN }}'
          script: |-
            const geminiOutput = process.env.GEMINI_OUTPUT;
            const issueNumber = parseInt(process.env.ISSUE_NUMBER);
            const userRequest = process.env.USER_REQUEST;
            
            core.info(`Raw Gemini output: ${geminiOutput}`);
            
            let analysis;
            let cleanedOutput = geminiOutput;
            
            // å¤šå±‚æ¸…ç†é€»è¾‘
            if (cleanedOutput) {
              // ç§»é™¤markdownä»£ç å—
              cleanedOutput = cleanedOutput.replace(/```json\s*/g, '').replace(/```\s*/g, '');
              // ç§»é™¤å‰åç©ºç™½
              cleanedOutput = cleanedOutput.trim();
              // ç§»é™¤å¯èƒ½çš„å¯¹è¯å‰ç¼€
              cleanedOutput = cleanedOutput.replace(/^Here's the analysis.*?:\s*/i, '');
              cleanedOutput = cleanedOutput.replace(/^Based on.*?:\s*/i, '');
              
              // å¦‚æœä¸æ˜¯ä»¥{å¼€å¤´ï¼Œå°è¯•ç”¨æ­£åˆ™æå–JSON
              if (!cleanedOutput.startsWith('{')) {
                const jsonMatch = cleanedOutput.match(/\{[\s\S]*\}/);
                if (jsonMatch) {
                  cleanedOutput = jsonMatch[0];
                }
              }
            }
            
            try {
              analysis = JSON.parse(cleanedOutput);
              core.info(`âœ… æˆåŠŸè§£æAIåˆ†æ: ${JSON.stringify(analysis)}`);
            } catch (error) {
              core.warning(`âŒ JSONè§£æå¤±è´¥: ${error.message}`);
              core.info(`åŸå§‹è¾“å‡º: ${geminiOutput}`);
              core.info(`æ¸…ç†åè¾“å‡º: ${cleanedOutput}`);
              
              // æ™ºèƒ½fallbackï¼šæä¾›ç”¨æˆ·å‹å¥½çš„é”™è¯¯å¤„ç†
              analysis = {
                analysis: "AIåŠ©æ‰‹åˆ†æè¿‡ç¨‹ä¸­é‡åˆ°äº†æ ¼å¼é—®é¢˜ï¼Œä½†ä»å°½åŠ›ä¸ºæ‚¨æä¾›å¸®åŠ©ã€‚",
                suggestions: [
                  "è¯·ç¨åé‡è¯•æ‚¨çš„è¯·æ±‚",
                  "å°è¯•é‡æ–°è¡¨è¿°æ‚¨çš„é—®é¢˜ï¼Œä½¿å…¶æ›´åŠ å…·ä½“",
                  "å¦‚æœé—®é¢˜æŒç»­ï¼Œè¯·è”ç³»ç®¡ç†å‘˜æ£€æŸ¥AIåŠ©æ‰‹é…ç½®"
                ],
                implementation_steps: [],
                priority: "medium",
                estimated_effort: "è¯·é‡æ–°æäº¤è¯·æ±‚è·å–å‡†ç¡®è¯„ä¼°"
              };
            }
            
            // æ„å»ºå›å¤æ¶ˆæ¯
            let replyMessage = `## ğŸ¤– AIåŠ©æ‰‹åˆ†æç»“æœ\n\n`;
            replyMessage += `**ç”¨æˆ·è¯·æ±‚**: ${userRequest}\n\n`;
            
            if (analysis.analysis) {
              replyMessage += `### ğŸ“‹ åˆ†æ\n${analysis.analysis}\n\n`;
            }
            
            if (analysis.suggestions && analysis.suggestions.length > 0) {
              replyMessage += `### ğŸ’¡ å»ºè®®\n`;
              analysis.suggestions.forEach((suggestion, index) => {
                replyMessage += `${index + 1}. ${suggestion}\n`;
              });
              replyMessage += '\n';
            }
            
            if (analysis.implementation_steps && analysis.implementation_steps.length > 0) {
              replyMessage += `### ğŸ”§ å®æ–½æ­¥éª¤\n`;
              analysis.implementation_steps.forEach((step, index) => {
                replyMessage += `${index + 1}. ${step}\n`;
              });
              replyMessage += '\n';
            }
            
            if (analysis.code_examples) {
              replyMessage += `### ğŸ’» ä»£ç ç¤ºä¾‹\n\`\`\`\n${analysis.code_examples}\n\`\`\`\n\n`;
            }
            
            if (analysis.additional_resources) {
              replyMessage += `### ğŸ“š ç›¸å…³èµ„æº\n${analysis.additional_resources}\n\n`;
            }
            
            if (analysis.priority) {
              const priorityEmoji = analysis.priority === 'high' ? 'ğŸ”´' : 
                                   analysis.priority === 'medium' ? 'ğŸŸ¡' : 'ğŸŸ¢';
              replyMessage += `**ä¼˜å…ˆçº§**: ${priorityEmoji} ${analysis.priority}\n`;
            }
            
            if (analysis.estimated_effort) {
              replyMessage += `**é¢„ä¼°å·¥ä½œé‡**: ${analysis.estimated_effort}\n`;
            }
            
            replyMessage += `\n---\n*ç”±AIæ™ºèƒ½åŠ©æ‰‹è‡ªåŠ¨ç”Ÿæˆ | å¦‚éœ€è¿›ä¸€æ­¥å¸®åŠ©ï¼Œè¯·ä½¿ç”¨ @abc å‘½ä»¤*`;
            
            // å‘è¡¨è¯„è®º
            await github.rest.issues.createComment({
              owner: context.repo.owner,
              repo: context.repo.repo,
              issue_number: issueNumber,
              body: replyMessage
            });
            
            core.info(`âœ… å·²æˆåŠŸå›å¤ç”¨æˆ·è¯·æ±‚ #${issueNumber}`);

      # æ­¥éª¤11: é”™è¯¯å¤„ç† - å¦‚æœAIåˆ†æå¤±è´¥ï¼Œé€šçŸ¥ç”¨æˆ·
      - name: 'Handle AI Analysis Failure'
        if: failure() && steps.run_gemini.outcome == 'failure'
        env:
          GITHUB_TOKEN: '${{ steps.generate_token.outputs.token || secrets.GITHUB_TOKEN }}'
          ISSUE_NUMBER: '${{ steps.get_context.outputs.issue_number }}'
          REPOSITORY: '${{ github.repository }}'
          USER_REQUEST: '${{ steps.get_context.outputs.user_request }}'
        run: |-
          set -euo pipefail
          ERROR_MESSAGE="## âš ï¸ AIåŠ©æ‰‹å¤„ç†å¤±è´¥
          
          **ç”¨æˆ·è¯·æ±‚**: ${USER_REQUEST}
          
          å¾ˆæŠ±æ­‰ï¼ŒAIåŠ©æ‰‹åœ¨å¤„ç†æ‚¨çš„è¯·æ±‚æ—¶é‡åˆ°äº†é—®é¢˜ã€‚å¯èƒ½çš„åŸå› ï¼š
          - ç½‘ç»œè¿æ¥é—®é¢˜
          - APIé…ç½®é—®é¢˜  
          - è¯·æ±‚å†…å®¹è¿‡äºå¤æ‚
          
          ### å»ºè®®
          1. è¯·ç¨åé‡è¯•
          2. å°è¯•ç®€åŒ–æ‚¨çš„è¯·æ±‚
          3. æ£€æŸ¥æ˜¯å¦æœ‰è¯­æ³•é”™è¯¯æˆ–ä¸æ¸…æ¥šçš„æè¿°
          
          å¦‚æœé—®é¢˜æŒç»­å­˜åœ¨ï¼Œè¯·è”ç³»ç®¡ç†å‘˜æ£€æŸ¥AIåŠ©æ‰‹é…ç½®ã€‚
          
          ---
          *AIæ™ºèƒ½åŠ©æ‰‹é”™è¯¯å¤„ç† | è¯·ä½¿ç”¨ @abc å‘½ä»¤é‡è¯•*"
          
          gh issue comment "${ISSUE_NUMBER}" --body "${ERROR_MESSAGE}" --repo "${REPOSITORY}"
