# å·¥ä½œæµåç§°
name: 'ğŸ¤– æ™ºèƒ½åŠ©æ‰‹å‘½ä»¤å¤„ç†å™¨ - å¤„ç†ç”¨æˆ·è¯·æ±‚å’Œå‘½ä»¤çš„æ ¸å¿ƒå·¥ä½œæµ'

# è§¦å‘æ¡ä»¶ï¼šå®šä¹‰ä¸ºå¯è¢«å…¶ä»–å·¥ä½œæµè°ƒç”¨
on:
  workflow_call:
    # å®šä¹‰è¾“å…¥å‚æ•°
    inputs:
      user_request:
        description: 'ä»è¯„è®ºæˆ– Issue æ­£æ–‡ä¸­æå–çš„ç”¨æˆ·è¯·æ±‚æ–‡æœ¬'
        required: true
        type: string
      issue_number:
        description: 'å…³è”çš„ Issue æˆ– PR ç¼–å·'
        required: true
        type: number
      is_pr:
        description: 'ä¸Šä¸‹æ–‡æ˜¯å¦ä¸ºä¸€ä¸ª Pull Request (true/false)'
        required: true
        type: boolean
    # å®šä¹‰æ‰€éœ€å¯†é’¥
    secrets:
      APP_PRIVATE_KEY:
        description: 'GitHub App çš„ç§é’¥'
        required: false
      GEMINI_API_KEY:
        description: 'Gemini API çš„å¯†é’¥'
        required: false

# å¹¶å‘æ§åˆ¶ï¼šç¡®ä¿å¯¹åŒä¸€ä¸ª Issue/PR çš„å¤„ç†ä¸ä¼šé‡å¤æ‰§è¡Œ
concurrency:
  group: '${{ github.workflow }}-${{ inputs.issue_number }}'
  cancel-in-progress: true

# é»˜è®¤è®¾ç½®
defaults:
  run:
    shell: 'bash'

# æƒé™è®¾ç½®
permissions:
  contents: 'write'      # éœ€è¦å†™å…¥æƒé™æ¥æäº¤ä»£ç ä¿®æ”¹
  id-token: 'write'
  pull-requests: 'write'
  issues: 'write'

# ä½œä¸šå®šä¹‰
jobs:
  gemini-cli:
    # è°ƒç”¨æ–¹è´Ÿè´£æ§åˆ¶æ‰§è¡Œé€»è¾‘ï¼Œæ•…ç§»é™¤ 'if' æ¡ä»¶
    timeout-minutes: 10
    runs-on: 'ubuntu-latest'
    
    # ä½œä¸šæ­¥éª¤
    steps:
      # æ­¥éª¤1: (å¯é€‰) ç”Ÿæˆ GitHub App Token
      - name: 'Generate GitHub App Token'
        id: 'generate_token'
        if: ${{ vars.APP_ID != '' }}
        uses: 'actions/create-github-app-token@v2'
        with:
          app-id: '${{ vars.APP_ID }}'
          private-key: '${{ secrets.APP_PRIVATE_KEY }}'

      # æ­¥éª¤2: ä»è°ƒç”¨æ–¹ä¼ å…¥çš„ inputs ä¸­è®¾ç½®ä¸Šä¸‹æ–‡ä¿¡æ¯
      - name: 'Set context from inputs'
        id: 'get_context'
        run: |-
          echo "user_request=${{ inputs.user_request }}" >> "${GITHUB_OUTPUT}"
          echo "issue_number=${{ inputs.issue_number }}" >> "${GITHUB_OUTPUT}"
          echo "is_pr=${{ inputs.is_pr }}" >> "${GITHUB_OUTPUT}"

      # æ­¥éª¤3: è®¾ç½® Git æäº¤è€…ä¿¡æ¯
      - name: 'Set up git user for commits'
        run: |-
          git config --global user.name 'gemini-cli[bot]'
          git config --global user.email 'gemini-cli[bot]@users.noreply.github.com'

      # æ­¥éª¤4: å¦‚æœæ˜¯ PRï¼Œæ£€å‡º PR æ‰€åœ¨çš„åˆ†æ”¯
      - name: 'Checkout PR branch'
        if: steps.get_context.outputs.is_pr == 'true'
        uses: 'actions/checkout@v4'
        with:
          token: '${{ steps.generate_token.outputs.token || secrets.GITHUB_TOKEN }}'
          repository: '${{ github.repository }}'
          ref: 'refs/pull/${{ steps.get_context.outputs.issue_number }}/head'
          fetch-depth: 0

      # æ­¥éª¤5: å¦‚æœæ˜¯ Issueï¼Œæ£€å‡ºé»˜è®¤ä¸»åˆ†æ”¯
      - name: 'Checkout main branch'
        if: steps.get_context.outputs.is_pr == 'false'
        uses: 'actions/checkout@v4'
        with:
          token: '${{ steps.generate_token.outputs.token || secrets.GITHUB_TOKEN }}'
          repository: '${{ github.repository }}'
          fetch-depth: 0

      # æ­¥éª¤6: åœ¨ Issue/PR ä¸‹å‘è¡¨è¯„è®ºï¼Œå‘ŠçŸ¥ç”¨æˆ·å·²å¼€å§‹å¤„ç†
      - name: 'Acknowledge request'
        env:
          GITHUB_ACTOR: '${{ github.actor }}'
          GITHUB_TOKEN: '${{ steps.generate_token.outputs.token || secrets.GITHUB_TOKEN }}'
          ISSUE_NUMBER: '${{ steps.get_context.outputs.issue_number }}'
          REPOSITORY: '${{ github.repository }}'
        run: |-
          set -euo pipefail
          MESSAGE="@${GITHUB_ACTOR} æˆ‘å·²æ”¶åˆ°æ‚¨çš„è¯·æ±‚ï¼Œæ­£åœ¨å¤„ç†ä¸­ï¼ğŸ¤–"
          gh issue comment "${ISSUE_NUMBER}" --body "${MESSAGE}" --repo "${REPOSITORY}"

      # æ­¥éª¤7: è·å– Issue æˆ– PR çš„æè¿°æ­£æ–‡
      - name: 'Get description'
        id: 'get_description'
        env:
          GITHUB_TOKEN: '${{ steps.generate_token.outputs.token || secrets.GITHUB_TOKEN }}'
          IS_PR: '${{ steps.get_context.outputs.is_pr }}'
          ISSUE_NUMBER: '${{ steps.get_context.outputs.issue_number }}'
        run: |-
          set -euo pipefail
          if [[ "${IS_PR}" == "true" ]]; then
            DESCRIPTION=$(gh pr view "${ISSUE_NUMBER}" --json body --template '{{.body}}')
          else
            DESCRIPTION=$(gh issue view "${ISSUE_NUMBER}" --json body --template '{{.body}}')
          fi
          {
            echo "description<<EOF"
            echo "${DESCRIPTION}"
            echo "EOF"
          } >> "${GITHUB_OUTPUT}"

      # æ­¥éª¤8: è·å– Issue æˆ– PR çš„æ‰€æœ‰è¯„è®º
      - name: 'Get comments'
        id: 'get_comments'
        env:
          GITHUB_TOKEN: '${{ steps.generate_token.outputs.token || secrets.GITHUB_TOKEN }}'
          IS_PR: '${{ steps.get_context.outputs.is_pr }}'
          ISSUE_NUMBER: '${{ steps.get_context.outputs.issue_number }}'
        run: |-
          set -euo pipefail
          if [[ "${IS_PR}" == "true" ]]; then
            COMMENTS=$(gh pr view "${ISSUE_NUMBER}" --json comments --template '{{range .comments}}{{.author.login}}: {{.body}}{{"\n"}}{{end}}')
          else
            COMMENTS=$(gh issue view "${ISSUE_NUMBER}" --json comments --template '{{range .comments}}{{.author.login}}: {{.body}}{{"\n"}}{{end}}')
          fi
          {
            echo "comments<<EOF"
            echo "${COMMENTS}"
            echo "EOF"
          } >> "${GITHUB_OUTPUT}"

      # æ­¥éª¤9: è¿è¡Œ Gemini CLI æ ¸å¿ƒé€»è¾‘
      - name: 'Run Gemini'
        id: 'run_gemini'
        uses: 'google-github-actions/run-gemini-cli@v0.1.12'
        env:
          # å°†å‰é¢æ‰€æœ‰æ­¥éª¤æ”¶é›†åˆ°çš„ä¸Šä¸‹æ–‡ä¿¡æ¯ä¼ é€’ç»™ Gemini
          GITHUB_TOKEN: '${{ steps.generate_token.outputs.token || secrets.GITHUB_TOKEN }}'
          REPOSITORY: '${{ github.repository }}'
          USER_REQUEST: '${{ steps.get_context.outputs.user_request }}'
          ISSUE_NUMBER: '${{ steps.get_context.outputs.issue_number }}'
          IS_PR: '${{ steps.get_context.outputs.is_pr }}'
        with:
          # Gemini CLI é…ç½®
          gemini_cli_version: 'v0.1.12'  # ä½¿ç”¨æœ€æ–°ç¨³å®šç‰ˆæœ¬
          gemini_api_key: '${{ secrets.GEMINI_API_KEY }}'
          gemini_debug: false  # å…³é—­è°ƒè¯•æ¨¡å¼
          gcp_workload_identity_provider: '${{ vars.GCP_WIF_PROVIDER }}'
          gcp_project_id: '${{ vars.GOOGLE_CLOUD_PROJECT }}'
          gcp_location: '${{ vars.GOOGLE_CLOUD_LOCATION }}'
          gcp_service_account: '${{ vars.SERVICE_ACCOUNT_EMAIL }}'
          use_vertex_ai: '${{ vars.GOOGLE_GENAI_USE_VERTEXAI }}'
          use_gemini_code_assist: '${{ vars.GOOGLE_GENAI_USE_GCA }}'
          settings: |-
            {
              "debug": false,
              "temperature": 0.3,
              "candidateCount": 1,
              "maxOutputTokens": 2048,
              "responseMimeType": "application/json",
              "systemInstruction": "ä½ æ˜¯ä¸€ä¸ªæœ‰ç”¨çš„AIåŠ©æ‰‹ï¼Œç”¨æœ‰æ•ˆçš„JSONæ ¼å¼å›å¤ï¼ŒåŒ…å«ä½ çš„åˆ†æå’Œå»ºè®®ã€‚è¯·ä½¿ç”¨ä¸­æ–‡è¿›è¡Œæ‰€æœ‰å›å¤å†…å®¹ã€‚"
            }
          prompt: |-
            é‡è¦æç¤ºï¼šè¯·åªç”¨æœ‰æ•ˆçš„JSONæ ¼å¼å›å¤ï¼Œä¸è¦åŒ…å«å¯¹è¯æ–‡æœ¬ã€‚è¯·ä½¿ç”¨ä¸­æ–‡è¿›è¡Œæ‰€æœ‰åˆ†æå’Œå»ºè®®ã€‚
            
            ä½ æ˜¯ä¸€ä¸ªæ™ºèƒ½AIåŠ©æ‰‹ï¼Œä¸“é—¨å¸®åŠ©GitHubé¡¹ç›®ç®¡ç†å’Œå¼€å‘ä»»åŠ¡ã€‚
            
            ç”¨æˆ·è¯·æ±‚: ${USER_REQUEST}
            ä»“åº“: ${REPOSITORY}
            Issue/PRç¼–å·: ${ISSUE_NUMBER}
            æ˜¯å¦ä¸ºPull Request: ${IS_PR}
            Issue/PRæè¿°: ${{ steps.get_description.outputs.description }}
            æœ€è¿‘è¯„è®º: ${{ steps.get_comments.outputs.comments }}
            
            èƒ½åŠ›èŒƒå›´:
            - ä»£ç åˆ†æå’Œå»ºè®®
            - é¡¹ç›®è§„åˆ’å’Œä»»åŠ¡åˆ†è§£
            - å¼€å‘æœ€ä½³å®è·µå»ºè®®
            - Bugè°ƒæŸ¥å’Œè§£å†³æ–¹æ¡ˆ
            - åŠŸèƒ½å®ç°æŒ‡å¯¼
            - ä»£ç å®¡æŸ¥å’Œä¼˜åŒ–
            - æ–‡æ¡£æ”¹è¿›å»ºè®®
            - æ¶æ„å»ºè®®
            - ç®€å•ä»£ç ç”Ÿæˆå’Œä¿®æ”¹
            - æ–‡ä»¶åˆ›å»ºå’Œå†…å®¹æ›´æ–°
            
            JSONå“åº”æ ¼å¼ (ä»…JSONæ ¼å¼):
            {
              "analysis": "ç®€è¦åˆ†æè¯·æ±‚å’Œä¸Šä¸‹æ–‡å†…å®¹",
              "suggestions": [
                "å…·ä½“å¯æ‰§è¡Œçš„å»ºè®®1",
                "å…·ä½“å¯æ‰§è¡Œçš„å»ºè®®2",
                "å…·ä½“å¯æ‰§è¡Œçš„å»ºè®®3"
              ],
              "implementation_steps": [
                "æ­¥éª¤1: è¯¦ç»†çš„å®æ–½æ­¥éª¤",
                "æ­¥éª¤2: è¯¦ç»†çš„å®æ–½æ­¥éª¤"
              ],
              "code_examples": "ç›¸å…³ä»£ç ç¤ºä¾‹(å¦‚é€‚ç”¨)",
              "additional_resources": "æœ‰ç”¨çš„é“¾æ¥æˆ–èµ„æº",
              "priority": "high|medium|low",
              "estimated_effort": "ç®€è¦å·¥ä½œé‡è¯„ä¼°",
              "can_auto_implement": false,
              "simple_file_operations": []
            }
            
            å¯é€‰: å¦‚æœè¯·æ±‚æ˜¯ç®€å•çš„ä»£ç ç”Ÿæˆ(å¦‚åˆ›å»ºå•ä¸ªæ–‡ä»¶ã€æ›´æ–°æ–‡æ¡£æˆ–å°ä»£ç ç‰‡æ®µ)ï¼Œå¯ä»¥è®¾ç½® "can_auto_implement": true å¹¶æä¾› "simple_file_operations":
            {
              "can_auto_implement": true,
              "simple_file_operations": [
                {
                  "action": "create|modify",
                  "file_path": "ç›¸å¯¹è·¯å¾„/æ–‡ä»¶å.æ‰©å±•å",
                  "content": "å®Œæ•´çš„æ–‡ä»¶å†…å®¹",
                  "description": "è¿™ä¸ªæ–‡ä»¶çš„ä½œç”¨è¯´æ˜"
                }
              ]
            }
            
            è§„åˆ™è¦æ±‚:
            - æä¾›å®ç”¨ã€å¯æ‰§è¡Œçš„å»ºè®®
            - å»ºè®®è¦å…·ä½“è¯¦ç»†
            - è€ƒè™‘é¡¹ç›®ä¸Šä¸‹æ–‡å’Œç°æœ‰ä»£ç 
            - ä¸“æ³¨äºæœ€ä½³å®è·µå’Œå¯ç»´æŠ¤æ€§
            - å¦‚æœæ˜¯bugï¼Œæä¾›è°ƒè¯•æ­¥éª¤
            - å¦‚æœæ˜¯åŠŸèƒ½è¯·æ±‚ï¼Œæä¾›å®ç°æ–¹æ³•
            - å¦‚æœæ˜¯ä¼˜åŒ–ï¼Œè§£é‡Šå¥½å¤„å’Œæ–¹æ³•
            - æ‰€æœ‰åˆ†æå’Œå»ºè®®å¿…é¡»ä½¿ç”¨ä¸­æ–‡

      # æ­¥éª¤10: å¤„ç†ç®€å•çš„ä»£ç æ“ä½œï¼ˆå¦‚æœAIå»ºè®®å¯ä»¥è‡ªåŠ¨å®ç°ï¼‰
      - name: 'Handle Simple Code Operations'
        id: 'handle_code_ops'
        env:
          GITHUB_TOKEN: '${{ steps.generate_token.outputs.token || secrets.GITHUB_TOKEN }}'
          GEMINI_OUTPUT: '${{ steps.run_gemini.outputs.summary }}'
          ISSUE_NUMBER: '${{ steps.get_context.outputs.issue_number }}'
          REPOSITORY: '${{ github.repository }}'
        uses: 'actions/github-script@v6'
        with:
          github-token: '${{ env.GITHUB_TOKEN }}'
          script: |-
            const fs = require('fs');
            const path = require('path');
            
            const geminiOutput = process.env.GEMINI_OUTPUT;
            const issueNumber = parseInt(process.env.ISSUE_NUMBER);
            
            let analysis;
            let cleanedOutput = geminiOutput;
            
            // æ¸…ç†JSONè¾“å‡º
            if (cleanedOutput) {
              cleanedOutput = cleanedOutput.replace(/```json\s*/g, '').replace(/```\s*/g, '');
              cleanedOutput = cleanedOutput.trim();
              if (!cleanedOutput.startsWith('{')) {
                const jsonMatch = cleanedOutput.match(/\{[\s\S]*\}/);
                if (jsonMatch) {
                  cleanedOutput = jsonMatch[0];
                }
              }
            }
            
            try {
              analysis = JSON.parse(cleanedOutput);
            } catch (error) {
              core.info('âŒ JSONè§£æå¤±è´¥ï¼Œè·³è¿‡ä»£ç æ“ä½œ');
              core.setOutput('code_operations_performed', false);
              return;
            }
            
            // æ£€æŸ¥æ˜¯å¦å¯ä»¥è‡ªåŠ¨å®ç°
            if (!analysis.can_auto_implement || !analysis.simple_file_operations || analysis.simple_file_operations.length === 0) {
              core.info('â„¹ï¸ æ— éœ€æ‰§è¡Œä»£ç æ“ä½œ');
              core.setOutput('code_operations_performed', false);
              return;
            }
            
            core.info('ğŸ¤– å¼€å§‹æ‰§è¡Œç®€å•ä»£ç æ“ä½œ...');
            
            let operationsPerformed = [];
            let operationsFailed = [];
            
            // æ‰§è¡Œæ–‡ä»¶æ“ä½œ
            for (const operation of analysis.simple_file_operations) {
              try {
                const filePath = operation.file_path;
                
                if (operation.action === 'create') {
                  // åˆ›å»ºæ–°æ–‡ä»¶
                  const dirPath = path.dirname(filePath);
                  if (dirPath !== '.' && !fs.existsSync(dirPath)) {
                    fs.mkdirSync(dirPath, { recursive: true });
                  }
                  fs.writeFileSync(filePath, operation.content || '');
                  operationsPerformed.push(`âœ¨ åˆ›å»ºæ–‡ä»¶: ${filePath} - ${operation.description}`);
                  core.info(`âœ… åˆ›å»ºæ–‡ä»¶: ${filePath}`);
                  
                } else if (operation.action === 'modify') {
                  // ä¿®æ”¹ç°æœ‰æ–‡ä»¶
                  if (fs.existsSync(filePath)) {
                    fs.writeFileSync(filePath, operation.content || '');
                    operationsPerformed.push(`ğŸ“ ä¿®æ”¹æ–‡ä»¶: ${filePath} - ${operation.description}`);
                    core.info(`âœ… ä¿®æ”¹æ–‡ä»¶: ${filePath}`);
                  } else {
                    // æ–‡ä»¶ä¸å­˜åœ¨ï¼Œåˆ›å»ºæ–°æ–‡ä»¶
                    const dirPath = path.dirname(filePath);
                    if (dirPath !== '.' && !fs.existsSync(dirPath)) {
                      fs.mkdirSync(dirPath, { recursive: true });
                    }
                    fs.writeFileSync(filePath, operation.content || '');
                    operationsPerformed.push(`âœ¨ åˆ›å»ºæ–‡ä»¶: ${filePath} - ${operation.description}`);
                    core.info(`âœ… åˆ›å»ºæ–‡ä»¶(åŸä¸ºä¿®æ”¹): ${filePath}`);
                  }
                }
              } catch (error) {
                const errorMsg = `âŒ æ“ä½œæ–‡ä»¶ ${operation.file_path} å¤±è´¥: ${error.message}`;
                operationsFailed.push(errorMsg);
                core.error(errorMsg);
              }
            }
            
            // è®¾ç½®è¾“å‡º
            core.setOutput('code_operations_performed', operationsPerformed.length > 0);
            core.setOutput('operations_summary', operationsPerformed.join('\n'));
            core.setOutput('operations_failed', operationsFailed.join('\n'));
            
            if (operationsPerformed.length > 0) {
              core.info(`ğŸ¯ ä»£ç æ“ä½œå®Œæˆ: ${operationsPerformed.length}ä¸ªæ“ä½œæˆåŠŸ, ${operationsFailed.length}ä¸ªæ“ä½œå¤±è´¥`);
            }

      # æ­¥éª¤11: å¤„ç†Geminiè¾“å‡ºå¹¶å›å¤ç”¨æˆ·
      - name: 'Process AI Response and Reply'
        env:
          GITHUB_TOKEN: '${{ steps.generate_token.outputs.token || secrets.GITHUB_TOKEN }}'
          ISSUE_NUMBER: '${{ steps.get_context.outputs.issue_number }}'
          REPOSITORY: '${{ github.repository }}'
          GEMINI_OUTPUT: '${{ steps.run_gemini.outputs.summary }}'
          USER_REQUEST: '${{ steps.get_context.outputs.user_request }}'
          CODE_OPS_PERFORMED: '${{ steps.handle_code_ops.outputs.code_operations_performed }}'
          OPERATIONS_SUMMARY: '${{ steps.handle_code_ops.outputs.operations_summary }}'
          OPERATIONS_FAILED: '${{ steps.handle_code_ops.outputs.operations_failed }}'
        uses: 'actions/github-script@v6'
        with:
          github-token: '${{ env.GITHUB_TOKEN }}'
          script: |-
            const geminiOutput = process.env.GEMINI_OUTPUT;
            const issueNumber = parseInt(process.env.ISSUE_NUMBER);
            const userRequest = process.env.USER_REQUEST;
            
            core.info(`Raw Gemini output: ${geminiOutput}`);
            
            let analysis;
            let cleanedOutput = geminiOutput;
            
            // å¤šå±‚æ¸…ç†é€»è¾‘
            if (cleanedOutput) {
              // ç§»é™¤markdownä»£ç å—
              cleanedOutput = cleanedOutput.replace(/```json\s*/g, '').replace(/```\s*/g, '');
              // ç§»é™¤å‰åç©ºç™½
              cleanedOutput = cleanedOutput.trim();
              // ç§»é™¤å¯èƒ½çš„å¯¹è¯å‰ç¼€
              cleanedOutput = cleanedOutput.replace(/^Here's the analysis.*?:\s*/i, '');
              cleanedOutput = cleanedOutput.replace(/^Based on.*?:\s*/i, '');
              
              // å¦‚æœä¸æ˜¯ä»¥{å¼€å¤´ï¼Œå°è¯•ç”¨æ­£åˆ™æå–JSON
              if (!cleanedOutput.startsWith('{')) {
                const jsonMatch = cleanedOutput.match(/\{[\s\S]*\}/);
                if (jsonMatch) {
                  cleanedOutput = jsonMatch[0];
                }
              }
            }
            
            try {
              analysis = JSON.parse(cleanedOutput);
              core.info(`âœ… æˆåŠŸè§£æAIåˆ†æ: ${JSON.stringify(analysis)}`);
            } catch (error) {
              core.warning(`âŒ JSONè§£æå¤±è´¥: ${error.message}`);
              core.info(`åŸå§‹è¾“å‡º: ${geminiOutput}`);
              core.info(`æ¸…ç†åè¾“å‡º: ${cleanedOutput}`);
              
              // æ™ºèƒ½fallbackï¼šæä¾›ç”¨æˆ·å‹å¥½çš„é”™è¯¯å¤„ç†
              analysis = {
                analysis: "AIåŠ©æ‰‹åˆ†æè¿‡ç¨‹ä¸­é‡åˆ°äº†æ ¼å¼é—®é¢˜ï¼Œä½†ä»å°½åŠ›ä¸ºæ‚¨æä¾›å¸®åŠ©ã€‚",
                suggestions: [
                  "è¯·ç¨åé‡è¯•æ‚¨çš„è¯·æ±‚",
                  "å°è¯•é‡æ–°è¡¨è¿°æ‚¨çš„é—®é¢˜ï¼Œä½¿å…¶æ›´åŠ å…·ä½“",
                  "å¦‚æœé—®é¢˜æŒç»­ï¼Œè¯·è”ç³»ç®¡ç†å‘˜æ£€æŸ¥AIåŠ©æ‰‹é…ç½®"
                ],
                implementation_steps: [],
                priority: "medium",
                estimated_effort: "è¯·é‡æ–°æäº¤è¯·æ±‚è·å–å‡†ç¡®è¯„ä¼°"
              };
            }
            
            // æ£€æŸ¥æ˜¯å¦æ‰§è¡Œäº†ä»£ç æ“ä½œ
            const codeOpsPerformed = process.env.CODE_OPS_PERFORMED === 'true';
            const operationsSummary = process.env.OPERATIONS_SUMMARY || '';
            const operationsFailed = process.env.OPERATIONS_FAILED || '';
            
            // æ„å»ºå›å¤æ¶ˆæ¯
            let replyMessage = `## ğŸ¤– AIåŠ©æ‰‹åˆ†æç»“æœ\n\n`;
            replyMessage += `**ç”¨æˆ·è¯·æ±‚**: ${userRequest}\n\n`;
            
            // å¦‚æœæ‰§è¡Œäº†ä»£ç æ“ä½œï¼Œå…ˆæ˜¾ç¤ºæ“ä½œç»“æœ
            if (codeOpsPerformed) {
              replyMessage += `## âœ… ä»£ç æ“ä½œå·²å®Œæˆ\n\n`;
              replyMessage += `æˆ‘å·²ç»æ ¹æ®åˆ†æè‡ªåŠ¨æ‰§è¡Œäº†ä»¥ä¸‹æ“ä½œï¼š\n\n`;
              if (operationsSummary) {
                operationsSummary.split('\n').forEach(op => {
                  if (op.trim()) {
                    replyMessage += `${op}\n`;
                  }
                });
              }
              if (operationsFailed) {
                replyMessage += `\nâš ï¸ **éƒ¨åˆ†æ“ä½œå¤±è´¥**:\n`;
                operationsFailed.split('\n').forEach(op => {
                  if (op.trim()) {
                    replyMessage += `${op}\n`;
                  }
                });
              }
              replyMessage += `\n---\n\n`;
            }
            
            if (analysis.analysis) {
              replyMessage += `### ğŸ“‹ åˆ†æ\n${analysis.analysis}\n\n`;
            }
            
            if (analysis.suggestions && analysis.suggestions.length > 0) {
              replyMessage += `### ğŸ’¡ å»ºè®®\n`;
              analysis.suggestions.forEach((suggestion, index) => {
                replyMessage += `${index + 1}. ${suggestion}\n`;
              });
              replyMessage += '\n';
            }
            
            if (analysis.implementation_steps && analysis.implementation_steps.length > 0) {
              replyMessage += `### ğŸ”§ å®æ–½æ­¥éª¤\n`;
              analysis.implementation_steps.forEach((step, index) => {
                replyMessage += `${index + 1}. ${step}\n`;
              });
              replyMessage += '\n';
            }
            
            if (analysis.code_examples) {
              replyMessage += `### ğŸ’» ä»£ç ç¤ºä¾‹\n\`\`\`\n${analysis.code_examples}\n\`\`\`\n\n`;
            }
            
            if (analysis.additional_resources) {
              replyMessage += `### ğŸ“š ç›¸å…³èµ„æº\n${analysis.additional_resources}\n\n`;
            }
            
            if (analysis.priority) {
              const priorityEmoji = analysis.priority === 'high' ? 'ğŸ”´' : 
                                   analysis.priority === 'medium' ? 'ğŸŸ¡' : 'ğŸŸ¢';
              replyMessage += `**ä¼˜å…ˆçº§**: ${priorityEmoji} ${analysis.priority}\n`;
            }
            
            if (analysis.estimated_effort) {
              replyMessage += `**é¢„ä¼°å·¥ä½œé‡**: ${analysis.estimated_effort}\n`;
            }
            
            replyMessage += `\n---\n`;
            
            if (codeOpsPerformed) {
              replyMessage += `*ğŸ¤– AIæ™ºèƒ½åŠ©æ‰‹å·²è‡ªåŠ¨æ‰§è¡Œä»£ç æ“ä½œå¹¶ç”Ÿæˆåˆ†æ | å¦‚éœ€è¿›ä¸€æ­¥å¸®åŠ©ï¼Œè¯·ä½¿ç”¨ @abc å‘½ä»¤*`;
            } else {
              replyMessage += `*ç”±AIæ™ºèƒ½åŠ©æ‰‹è‡ªåŠ¨ç”Ÿæˆ | å¦‚éœ€ä»£ç è‡ªåŠ¨ç”Ÿæˆï¼Œè¯·æ˜ç¡®è¯´æ˜è¦åˆ›å»ºçš„æ–‡ä»¶ | ä½¿ç”¨ @abc è·å–æ›´å¤šå¸®åŠ©*`;
            }
            
            // å‘è¡¨è¯„è®º
            await github.rest.issues.createComment({
              owner: context.repo.owner,
              repo: context.repo.repo,
              issue_number: issueNumber,
              body: replyMessage
            });
            
            core.info(`âœ… å·²æˆåŠŸå›å¤ç”¨æˆ·è¯·æ±‚ #${issueNumber}`);

      # æ­¥éª¤12: é”™è¯¯å¤„ç† - å¦‚æœAIåˆ†æå¤±è´¥ï¼Œé€šçŸ¥ç”¨æˆ·
      - name: 'Handle AI Analysis Failure'
        if: failure() && steps.run_gemini.outcome == 'failure'
        env:
          GITHUB_TOKEN: '${{ steps.generate_token.outputs.token || secrets.GITHUB_TOKEN }}'
          ISSUE_NUMBER: '${{ steps.get_context.outputs.issue_number }}'
          REPOSITORY: '${{ github.repository }}'
          USER_REQUEST: '${{ steps.get_context.outputs.user_request }}'
        run: |-
          set -euo pipefail
          ERROR_MESSAGE="## âš ï¸ AIåŠ©æ‰‹å¤„ç†å¤±è´¥
          
          **ç”¨æˆ·è¯·æ±‚**: ${USER_REQUEST}
          
          å¾ˆæŠ±æ­‰ï¼ŒAIåŠ©æ‰‹åœ¨å¤„ç†æ‚¨çš„è¯·æ±‚æ—¶é‡åˆ°äº†é—®é¢˜ã€‚å¯èƒ½çš„åŸå› ï¼š
          - ç½‘ç»œè¿æ¥é—®é¢˜
          - APIé…ç½®é—®é¢˜  
          - è¯·æ±‚å†…å®¹è¿‡äºå¤æ‚
          
          ### å»ºè®®
          1. è¯·ç¨åé‡è¯•
          2. å°è¯•ç®€åŒ–æ‚¨çš„è¯·æ±‚
          3. æ£€æŸ¥æ˜¯å¦æœ‰è¯­æ³•é”™è¯¯æˆ–ä¸æ¸…æ¥šçš„æè¿°
          
          å¦‚æœé—®é¢˜æŒç»­å­˜åœ¨ï¼Œè¯·è”ç³»ç®¡ç†å‘˜æ£€æŸ¥AIåŠ©æ‰‹é…ç½®ã€‚
          
          ---
          *AIæ™ºèƒ½åŠ©æ‰‹é”™è¯¯å¤„ç† | è¯·ä½¿ç”¨ @abc å‘½ä»¤é‡è¯•*"
          
          gh issue comment "${ISSUE_NUMBER}" --body "${ERROR_MESSAGE}" --repo "${REPOSITORY}"
