# ===============================================
# ğŸš¦ æ™ºèƒ½è°ƒåº¦ä¸­å¿ƒ - ç»Ÿä¸€AIåŠ©æ‰‹å…¥å£å’Œå‘½ä»¤è·¯ç”±
# ===============================================
# 
# ğŸ¯ ç”¨é€”ï¼šä½œä¸ºæ‰€æœ‰AIåŠŸèƒ½çš„ç»Ÿä¸€å…¥å£ï¼Œæ ¹æ®äº‹ä»¶ç±»å‹å’Œå‘½ä»¤è·¯ç”±åˆ°å¯¹åº”å·¥ä½œæµ
# ğŸ“‹ åŠŸèƒ½ï¼š
#   - è§£æç”¨æˆ·å‘½ä»¤å’Œæ„å›¾
#   - æ™ºèƒ½è·¯ç”±åˆ°å¯¹åº”çš„AIå·¥ä½œæµ
#   - ç»Ÿä¸€çš„æƒé™å’Œå®‰å…¨æ§åˆ¶
#   - å‘½ä»¤æ—¥å¿—å’Œå®¡è®¡
# 
# ğŸ”— ä¾èµ–ï¼šè°ƒç”¨å…¶ä»–AIåŠ©æ‰‹å·¥ä½œæµ
# ğŸ¤– AIæ¨¡å‹ï¼šGoogle Gemini API
# ===============================================

name: ğŸš¦ æ™ºèƒ½è°ƒåº¦ä¸­å¿ƒ - AIåŠ©æ‰‹ç»Ÿä¸€å…¥å£

# ğŸš€ è§¦å‘æ¡ä»¶ï¼šæ‰€æœ‰éœ€è¦AIå¤„ç†çš„GitHubäº‹ä»¶
on:
  # ğŸ’¬ è¯„è®ºäº‹ä»¶ (åŒ…å«å‘½ä»¤)
  issue_comment:
    types: [created]
    
  # ğŸ› Issueäº‹ä»¶
  issues:
    types: [opened, reopened]
    
  # ğŸ“‹ PRäº‹ä»¶
  pull_request:
    types: [opened, reopened, synchronize]

# ğŸ“ é»˜è®¤æƒé™ï¼šåªè¯»ï¼Œå…·ä½“æƒé™ç”±å­å·¥ä½œæµæ§åˆ¶
permissions:
  contents: read
  issues: read
  pull-requests: read

jobs:
  # ===============================
  # ğŸ§  æ™ºèƒ½æ„å›¾è¯†åˆ«å’Œè·¯ç”±
  # ===============================
  intelligent-routing:
    name: ğŸ§  AIå‘½ä»¤è§£æä¸è·¯ç”±
    runs-on: ubuntu-latest
    
    # ğŸ”„ è¾“å‡ºï¼šå†³å®šè°ƒç”¨å“ªäº›å­å·¥ä½œæµ
    outputs:
      need_pr_review: ${{ steps.router.outputs.need_pr_review }}
      need_issue_triage: ${{ steps.router.outputs.need_issue_triage }}
      need_ai_assistant: ${{ steps.router.outputs.need_ai_assistant }}
      user_command: ${{ steps.router.outputs.user_command }}
      action_type: ${{ steps.router.outputs.action_type }}
    
    steps:
      # æ­¥éª¤1: åˆ†æäº‹ä»¶ç±»å‹å’Œç”¨æˆ·æ„å›¾
      - name: ğŸ” åˆ†æäº‹ä»¶å’Œè§£æå‘½ä»¤
        id: router
        run: |
          echo "ğŸ¯ å¼€å§‹åˆ†æGitHubäº‹ä»¶å’Œç”¨æˆ·æ„å›¾..."
          
          # è·å–äº‹ä»¶ä¿¡æ¯
          EVENT_NAME="${{ github.event_name }}"
          echo "event_type=${EVENT_NAME}" >> $GITHUB_OUTPUT
          
          # åˆå§‹åŒ–è¾“å‡ºå˜é‡
          echo "need_pr_review=false" >> $GITHUB_OUTPUT
          echo "need_issue_triage=false" >> $GITHUB_OUTPUT
          echo "need_ai_assistant=false" >> $GITHUB_OUTPUT
          echo "user_command=" >> $GITHUB_OUTPUT
          echo "action_type=none" >> $GITHUB_OUTPUT
          
          # æ ¹æ®äº‹ä»¶ç±»å‹å†³å®šè·¯ç”±
          case "$EVENT_NAME" in
            "pull_request")
              echo "ğŸ“‹ æ£€æµ‹åˆ°PRäº‹ä»¶ï¼Œå¯ç”¨ä»£ç å®¡æŸ¥"
              echo "need_pr_review=true" >> $GITHUB_OUTPUT
              echo "action_type=pr_review" >> $GITHUB_OUTPUT
              ;;
              
            "issues")
              echo "ğŸ› æ£€æµ‹åˆ°Issueäº‹ä»¶ï¼Œå¯ç”¨é—®é¢˜åˆ†ç±»"
              echo "need_issue_triage=true" >> $GITHUB_OUTPUT
              echo "action_type=issue_triage" >> $GITHUB_OUTPUT
              ;;
              
            "issue_comment")
              # æ£€æŸ¥è¯„è®ºå†…å®¹ä¸­çš„å‘½ä»¤
              COMMENT_BODY="${{ github.event.comment.body }}"
              echo "ğŸ’¬ åˆ†æè¯„è®ºå†…å®¹: $COMMENT_BODY"
              
              if echo "$COMMENT_BODY" | grep -q "@abc"; then
                echo "ğŸ¤– æ£€æµ‹åˆ°AIåŠ©æ‰‹å‘½ä»¤"
                echo "need_ai_assistant=true" >> $GITHUB_OUTPUT
                echo "user_command=$COMMENT_BODY" >> $GITHUB_OUTPUT
                echo "action_type=ai_assistant" >> $GITHUB_OUTPUT
                
              elif echo "$COMMENT_BODY" | grep -qi "/review"; then
                echo "ğŸ” æ£€æµ‹åˆ°ä»£ç å®¡æŸ¥å‘½ä»¤"
                echo "need_pr_review=true" >> $GITHUB_OUTPUT
                echo "action_type=manual_review" >> $GITHUB_OUTPUT
                
              elif echo "$COMMENT_BODY" | grep -qi "/triage"; then
                echo "ğŸ·ï¸ æ£€æµ‹åˆ°é—®é¢˜åˆ†ç±»å‘½ä»¤"
                echo "need_issue_triage=true" >> $GITHUB_OUTPUT
                echo "action_type=manual_triage" >> $GITHUB_OUTPUT
                
              else
                echo "â“ æœªè¯†åˆ«çš„å‘½ä»¤ï¼Œè·³è¿‡å¤„ç†"
                echo "action_type=unknown" >> $GITHUB_OUTPUT
              fi
              ;;
          esac
          
          echo "âœ… è·¯ç”±åˆ†æå®Œæˆ"

  # ===============================
  # ğŸ” è°ƒç”¨ä»£ç å®¡æŸ¥å·¥ä½œæµ
  # ===============================
  call-pr-review:
    name: ğŸ” è°ƒç”¨ä»£ç å®¡æŸ¥åŠ©æ‰‹
    if: needs.intelligent-routing.outputs.need_pr_review == 'true'
    needs: intelligent-routing
    uses: ./.github/workflows/ä»£ç å®¡æŸ¥åŠ©æ‰‹.yml
    with:
      pr_number: ${{ github.event.pull_request.number || github.event.issue.number }}
    secrets: inherit

  # ===============================
  # ğŸ·ï¸ è°ƒç”¨é—®é¢˜åˆ†ç±»å·¥ä½œæµ
  # ===============================
  call-issue-triage:
    name: ğŸ·ï¸ è°ƒç”¨é—®é¢˜è‡ªåŠ¨åˆ†ç±»å™¨
    if: needs.intelligent-routing.outputs.need_issue_triage == 'true'
    needs: intelligent-routing
    uses: ./.github/workflows/é—®é¢˜è‡ªåŠ¨åˆ†ç±»å™¨.yml
    with:
      issue_number: ${{ github.event.issue.number }}
      issue_title: ${{ github.event.issue.title }}
      issue_body: ${{ github.event.issue.body }}
    secrets: inherit

  # ===============================
  # ğŸ¤– è°ƒç”¨AIåŠ©æ‰‹å·¥ä½œæµ
  # ===============================
  call-ai-assistant:
    name: ğŸ¤– è°ƒç”¨æ™ºèƒ½åŠ©æ‰‹å‘½ä»¤å¤„ç†å™¨
    if: needs.intelligent-routing.outputs.need_ai_assistant == 'true'
    needs: intelligent-routing
    uses: ./.github/workflows/æ™ºèƒ½åŠ©æ‰‹å‘½ä»¤å¤„ç†å™¨.yml
    with:
      user_request: ${{ needs.intelligent-routing.outputs.user_command }}
      issue_number: ${{ github.event.issue.number }}
      is_pr: ${{ github.event.issue.pull_request != null }}
    secrets: inherit

  # ===============================
  # ğŸ“Š æ‰§è¡Œç»“æœæ±‡æ€»
  # ===============================
  summary-results:
    name: ğŸ“Š AIå¤„ç†ç»“æœæ±‡æ€»
    if: always()
    needs: [intelligent-routing, call-pr-review, call-issue-triage, call-ai-assistant]
    runs-on: ubuntu-latest
    
    steps:
      - name: ğŸ“‹ æ±‡æ€»å¤„ç†ç»“æœ
        run: |
          echo "ğŸ¯ AIåŠ©æ‰‹å¤„ç†æ±‡æ€»æŠ¥å‘Š"
          echo "==================="
          echo "äº‹ä»¶ç±»å‹: ${{ needs.intelligent-routing.outputs.action_type }}"
          echo "ä»£ç å®¡æŸ¥: ${{ needs.call-pr-review.result || 'skipped' }}"
          echo "é—®é¢˜åˆ†ç±»: ${{ needs.call-issue-triage.result || 'skipped' }}"
          echo "AIåŠ©æ‰‹: ${{ needs.call-ai-assistant.result || 'skipped' }}"
          echo "==================="
          
          # ç»Ÿè®¡æˆåŠŸç‡
          total=0
          success=0
          
          if [ "${{ needs.call-pr-review.result }}" != "" ]; then
            total=$((total + 1))
            [ "${{ needs.call-pr-review.result }}" == "success" ] && success=$((success + 1))
          fi
          
          if [ "${{ needs.call-issue-triage.result }}" != "" ]; then
            total=$((total + 1))
            [ "${{ needs.call-issue-triage.result }}" == "success" ] && success=$((success + 1))
          fi
          
          if [ "${{ needs.call-ai-assistant.result }}" != "" ]; then
            total=$((total + 1))
            [ "${{ needs.call-ai-assistant.result }}" == "success" ] && success=$((success + 1))
          fi
          
          if [ $total -gt 0 ]; then
            success_rate=$((success * 100 / total))
            echo "âœ… æˆåŠŸç‡: $success_rate% ($success/$total)"
          else
            echo "â„¹ï¸ æœ¬æ¬¡æœªè§¦å‘ä»»ä½•AIå¤„ç†æµç¨‹"
          fi

# ===============================================
# ğŸ“‹ ä½¿ç”¨è¯´æ˜
# ===============================================
#
# ğŸ¯ è§¦å‘æ–¹å¼ï¼š
#   1. è‡ªåŠ¨è§¦å‘ï¼š
#      - åˆ›å»º/é‡å¼€Issue â†’ è‡ªåŠ¨åˆ†ç±»
#      - åˆ›å»º/æ›´æ–°PR â†’ è‡ªåŠ¨å®¡æŸ¥
#   
#   2. æ‰‹åŠ¨å‘½ä»¤ï¼š
#      - @abc [è¯·æ±‚] â†’ AIåŠ©æ‰‹å¤„ç†
#      - /review â†’ æ‰‹åŠ¨è§¦å‘ä»£ç å®¡æŸ¥
#      - /triage â†’ æ‰‹åŠ¨è§¦å‘é—®é¢˜åˆ†ç±»
#
# ğŸ”§ æ‰©å±•æ–¹æ³•ï¼š
#   - åœ¨è·¯ç”±é€»è¾‘ä¸­æ·»åŠ æ–°çš„å‘½ä»¤è¯†åˆ«
#   - åˆ›å»ºæ–°çš„å­å·¥ä½œæµå¹¶åœ¨æ­¤è°ƒç”¨
#   - æ”¯æŒæ›´å¤æ‚çš„AIæ„å›¾ç†è§£
#
# ğŸ›¡ï¸ å®‰å…¨ç‰¹æ€§ï¼š
#   - åªè¯»æƒé™ï¼Œå…·ä½“æƒé™ç”±å­å·¥ä½œæµæ§åˆ¶
#   - ç»Ÿä¸€çš„å‘½ä»¤å®¡è®¡å’Œæ—¥å¿—
#   - æ”¯æŒæƒé™éš”ç¦»å’Œè®¿é—®æ§åˆ¶
#
# ===============================================
